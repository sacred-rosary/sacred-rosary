<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sacred Rosary - Advanced Edition</title>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <!-- Three.js loaders -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/loaders/OBJLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/loaders/MTLLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/loaders/FBXLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/loaders/DRACOLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
    
    <!-- Custom font -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Default theme (Ordinary Time) */
            --primary-color: #35724a;
            --secondary-color: #264d33;
            --accent-color: #e6c875;
            --text-color: #f8f1e2;
            --background-color: #0a1015;
            --overlay-color: rgba(10, 16, 21, 0.85);
            --border-color: rgba(230, 200, 117, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.6);
            --glow-color: rgba(230, 200, 117, 0.4);
            --scroll-color: rgba(53, 114, 74, 0.5);
            --selection-color: rgba(230, 200, 117, 0.2);
            
            /* Animation durations */
            --transition-fast: 0.3s;
            --transition-medium: 0.6s;
            --transition-slow: 1s;
            --transition-very-slow: 2s;
            
            /* Layout */
            --prayer-width: 40%;
            --model-width: 60%;
            --margin-standard: 2rem;
            --padding-standard: 2rem;
            --border-radius-small: 8px;
            --border-radius-medium: 15px;
            --border-radius-large: 30px;
            
            /* Typography */
            --font-primary: 'Cinzel', serif;
            --font-secondary: 'Cormorant Garamond', serif;
            --font-size-xs: 0.875rem;
            --font-size-sm: 1rem;
            --font-size-md: 1.25rem;
            --font-size-lg: 1.5rem;
            --font-size-xl: 2rem;
            --font-size-2xl: 2.5rem;
            --font-size-3xl: 3rem;
            --font-size-4xl: 4rem;
            
            /* Z-index layers */
            --z-base: 1;
            --z-above: 10;
            --z-higher: 100;
            --z-modal: 1000;
            --z-overlay: 2000;
            --z-tooltip: 3000;
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-color) transparent;
        }

        body {
            font-family: var(--font-secondary);
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            position: relative;
            line-height: 1.6;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::selection {
            background-color: var(--selection-color);
            color: var(--text-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--scroll-color);
            border-radius: 3px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-primary);
            font-weight: 600;
            color: var(--accent-color);
            letter-spacing: 1px;
            line-height: 1.3;
        }

        a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color var(--transition-fast) ease;
        }

        a:hover {
            color: var(--text-color);
        }

        button {
            cursor: pointer;
            font-family: var(--font-primary);
        }

        /* Main container */
        .app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* Background effects */
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-base);
            pointer-events: none;
        }

        .gradient-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(10, 16, 21, 0.8) 0%, rgba(5, 8, 10, 0.95) 70%, rgba(0, 0, 0, 1) 100%);
            z-index: var(--z-base);
        }

        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: calc(var(--z-base) + 1);
        }

        .vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 60%, rgba(0, 0, 0, 0.6) 100%);
            z-index: calc(var(--z-base) + 2);
        }

        .candle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(255, 220, 150, 0.05) 0%, transparent 70%);
            mix-blend-mode: overlay;
            z-index: calc(var(--z-base) + 3);
            animation: flicker 8s infinite alternate;
        }

        .light-rays {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><radialGradient id="rgrad" cx="50%" cy="50%" r="75%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:rgb(255,220,150);stop-opacity:0.05" /><stop offset="100%" style="stop-color:rgb(255,220,150);stop-opacity:0" /></radialGradient></defs><rect x="0" y="0" width="100" height="100" fill="url(%23rgrad)" /></svg>');
            background-size: cover;
            mix-blend-mode: screen;
            opacity: 0.5;
            z-index: calc(var(--z-base) + 4);
            animation: rotate 240s linear infinite;
        }

        /* Main content layout */
        .main-content {
            position: relative;
            display: flex;
            width: 100%;
            height: 100vh;
            z-index: var(--z-above);
        }

        /* Prayer section */
        .prayer-section {
            position: relative;
            width: var(--prayer-width);
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: calc(var(--z-above) + 1);
        }

        .prayer-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-color);
            backdrop-filter: blur(8px);
            border-right: 1px solid var(--border-color);
            z-index: calc(var(--z-above) + 2);
        }

        .prayer-scroll {
            position: relative;
            flex: 1;
            overflow-y: auto;
            padding: var(--padding-standard);
            z-index: calc(var(--z-above) + 3);
            margin: 1rem;
            mask-image: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 1) 5%, rgba(0, 0, 0, 1) 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 1) 5%, rgba(0, 0, 0, 1) 95%, transparent 100%);
        }

        .prayer-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .prayer-title {
            font-size: var(--font-size-2xl);
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px var(--glow-color);
            position: relative;
        }

        .prayer-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 2px;
            background-color: var(--accent-color);
            box-shadow: 0 0 5px var(--glow-color);
        }

        .prayer-instructions {
            font-style: italic;
            margin: 1.5rem 0;
            opacity: 0.8;
            font-size: var(--font-size-md);
        }

        .prayer-text {
            font-size: var(--font-size-lg);
            line-height: 1.8;
            margin-bottom: 2rem;
            text-shadow: 0 0 5px var(--shadow-color);
        }

        .prayer-text p {
            margin-bottom: 1rem;
        }

        .prayer-controls {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
            z-index: calc(var(--z-above) + 3);
        }

        .prayer-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            padding: 0.75rem 1.5rem;
            font-family: var(--font-primary);
            font-size: var(--font-size-sm);
            letter-spacing: 1px;
            transition: all var(--transition-fast) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .prayer-btn:hover {
            background-color: var(--primary-color);
            box-shadow: 0 6px 12px var(--shadow-color), 0 0 15px var(--glow-color);
            transform: translateY(-2px);
        }

        .prayer-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .prayer-btn.prev-btn {
            padding-left: 1.25rem;
        }

        .prayer-btn.next-btn {
            padding-right: 1.25rem;
        }

        .prayer-btn.play-btn {
            flex: 1;
            max-width: 120px;
        }

        .prayer-btn.settings-btn,
        .prayer-btn.info-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .prayer-btn.autoplay-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            opacity: 0.8;
        }

        .prayer-btn.autoplay-toggle.active {
            background-color: var(--primary-color);
            opacity: 1;
        }

        /* Volume control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 1rem;
        }

        .volume-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }

        /* Progress indicator */
        .rosary-progress {
            position: relative;
            width: 100%;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-size: var(--font-size-md);
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        .decade-indicator {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .decade-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: all var(--transition-fast) ease;
        }

        .decade-dot.active {
            background-color: var(--accent-color);
            box-shadow: 0 0 8px var(--glow-color);
        }

        .decade-dot.completed {
            background-color: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
        }

        .bead-indicator {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            max-width: 300px;
        }

        .bead {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: all var(--transition-fast) ease;
        }

        .bead.larger {
            width: 14px;
            height: 14px;
            background-color: var(--accent-color);
            opacity: 0.4;
        }

        .bead.active {
            background-color: var(--accent-color);
            box-shadow: 0 0 8px var(--glow-color);
            transform: scale(1.2);
        }

        .bead.completed {
            background-color: var(--primary-color);
        }

        /* 3D model section */
        .model-section {
            position: relative;
            width: var(--model-width);
            height: 100%;
            z-index: calc(var(--z-above) + 1);
        }

        .model-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: calc(var(--z-above) + 2);
        }

        #model-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        .model-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: calc(var(--z-above) + 3);
        }

        .model-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--overlay-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: all var(--transition-fast) ease;
        }

        .model-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-color), 0 0 15px var(--glow-color);
        }

        .model-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        /* Mystery info panel */
        .mystery-info {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background-color: var(--overlay-color);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px var(--shadow-color);
            z-index: calc(var(--z-above) + 3);
            transform: translateY(-10px);
            opacity: 0;
            transition: all var(--transition-medium) ease;
            pointer-events: none;
        }

        .mystery-info.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .mystery-title {
            font-size: var(--font-size-lg);
            margin-bottom: 1rem;
            text-align: center;
        }

        .mystery-description {
            font-size: var(--font-size-sm);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .mystery-fruits {
            font-size: var(--font-size-xs);
            font-style: italic;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Landing page */
        .landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: var(--z-modal);
            transition: opacity var(--transition-slow) ease, transform var(--transition-slow) ease;
        }

        .landing-content {
            max-width: 800px;
            text-align: center;
            padding: 2rem;
            background-color: var(--overlay-color);
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px var(--shadow-color);
            animation: float 8s ease-in-out infinite;
        }

        .app-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 0 20px var(--glow-color));
        }

        .app-title {
            font-size: var(--font-size-3xl);
            margin-bottom: 1rem;
            letter-spacing: 4px;
            text-shadow: 0 0 20px var(--glow-color);
        }

        .app-subtitle {
            font-size: var(--font-size-md);
            margin-bottom: 2.5rem;
            opacity: 0.8;
        }

        .rosary-selection {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .rosary-selection-label {
            font-size: var(--font-size-lg);
            margin-bottom: 1rem;
        }

        .mystery-selection {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .mystery-btn {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            padding: 0.75rem 1.5rem;
            font-family: var(--font-primary);
            font-size: var(--font-size-sm);
            transition: all var(--transition-fast) ease;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .mystery-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-color), 0 0 10px var(--glow-color);
        }

        .mystery-btn.active {
            background-color: var(--primary-color);
            box-shadow: 0 4px 12px var(--shadow-color), 0 0 15px var(--glow-color);
        }

        .start-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius-large);
            padding: 1rem 2.5rem;
            font-family: var(--font-primary);
            font-size: var(--font-size-lg);
            letter-spacing: 2px;
            transition: all var(--transition-fast) ease;
            box-shadow: 0 8px 16px var(--shadow-color);
            margin-bottom: 2rem;
        }

        .start-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 24px var(--shadow-color), 0 0 20px var(--glow-color);
        }

        .start-btn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 6px 12px var(--shadow-color);
        }

        .app-version {
            font-size: var(--font-size-xs);
            opacity: 0.6;
            font-style: italic;
        }

        /* Settings modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: var(--z-modal);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-medium) ease;
        }

        .settings-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-content {
            width: 90%;
            max-width: 700px;
            background-color: var(--overlay-color);
            border-radius: var(--border-radius-medium);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px var(--shadow-color);
            padding: 2rem;
            transform: translateY(20px);
            transition: transform var(--transition-medium) ease;
        }

        .settings-modal.visible .settings-content {
            transform: translateY(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: var(--font-size-xl);
        }

        .close-settings {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: var(--font-size-xl);
            cursor: pointer;
            transition: color var(--transition-fast) ease;
        }

        .close-settings:hover {
            color: var(--accent-color);
        }

        .settings-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .settings-section {
            margin-bottom: 1.5rem;
        }

        .settings-section-title {
            font-size: var(--font-size-md);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .setting-label {
            font-size: var(--font-size-sm);
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: var(--transition-fast);
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-color);
            transition: var(--transition-fast);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .range-slider {
            -webkit-appearance: none;
            width: 150px;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }

        .range-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }

        .select-container {
            position: relative;
        }

        .settings-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
            padding: 0.5rem 2rem 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            color: var(--text-color);
            font-family: var(--font-secondary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            background-color: rgba(10, 16, 21, 0.6);
            min-width: 150px;
        }

        .select-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .settings-btn-group {
            display: flex;
            gap: 0.5rem;
        }

        .settings-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            font-family: var(--font-secondary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast) ease;
        }

        .settings-btn:hover {
            background-color: var(--secondary-color);
        }

        .settings-btn.active {
            background-color: var(--primary-color);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: var(--z-overlay);
            transition: opacity var(--transition-slow) ease, visibility var(--transition-slow) ease;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .loading-icon {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .loading-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        .loading-circle:nth-child(2) {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border-top-color: var(--primary-color);
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .loading-circle:nth-child(3) {
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            border-top-color: var(--secondary-color);
            animation-duration: 1s;
        }

        .loading-text {
            font-size: var(--font-size-lg);
            color: var(--accent-color);
            letter-spacing: 2px;
            text-align: center;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .loading-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--overlay-color);
            color: var(--text-color);
            text-align: center;
            border-radius: var(--border-radius-small);
            padding: 0.75rem;
            position: absolute;
            z-index: var(--z-tooltip);
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity var(--transition-fast) ease;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 8px var(--shadow-color);
            font-size: var(--font-size-xs);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--border-color) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--overlay-color);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
            border-radius: var(--border-radius-small);
            padding: 1rem;
            box-shadow: 0 4px 8px var(--shadow-color);
            z-index: var(--z-tooltip);
            transform: translateX(120%);
            transition: transform var(--transition-medium) ease;
            max-width: 300px;
        }

        .notification.visible {
            transform: translateX(0);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-size: var(--font-size-sm);
            font-weight: bold;
        }

        .notification-close {
            background: transparent;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: var(--font-size-md);
            line-height: 1;
        }

        .notification-message {
            font-size: var(--font-size-xs);
        }

        /* Animations */
        @keyframes flicker {
            0%, 100% {
                opacity: 0.9;
            }
            25% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
            75% {
                opacity: 0.85;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--glow-color);
            }
            50% {
                box-shadow: 0 0 20px var(--glow-color);
            }
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            :root {
                --prayer-width: 45%;
                --model-width: 55%;
            }
        }

        @media (max-width: 992px) {
            :root {
                --prayer-width: 50%;
                --model-width: 50%;
            }
            
            .prayer-title {
                font-size: var(--font-size-xl);
            }
            
            .prayer-text {
                font-size: var(--font-size-md);
            }
            
            .mystery-info {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            :root {
                --prayer-width: 100%;
                --model-width: 100%;
            }
            
            .prayer-section {
                height: 60%;
            }
            
            .model-section {
                height: 40%;
            }
            
            .prayer-backdrop {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .app-title {
                font-size: var(--font-size-2xl);
            }
            
            .mystery-btn {
                padding: 0.5rem 1rem;
                font-size: var(--font-size-xs);
            }
            
            .mystery-info {
                width: 90%;
                max-width: 300px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        }

        @media (max-width: 480px) {
            .prayer-controls {
                flex-wrap: wrap;
            }
            
            .prayer-btn {
                padding: 0.5rem 1rem;
                font-size: var(--font-size-xs);
            }
            
            .start-btn {
                padding: 0.75rem 1.5rem;
                font-size: var(--font-size-md);
            }
            
            .app-title {
                font-size: var(--font-size-xl);
            }
            
            .settings-sections {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay">
        <div class="loading-container">
            <div class="loading-icon">
                <div class="loading-circle"></div>
                <div class="loading-circle"></div>
                <div class="loading-circle"></div>
            </div>
            <div class="loading-text">Loading The Sacred Rosary</div>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- Application container -->
    <div class="app-container">
        <!-- Background effects -->
        <div class="background-effects">
            <div class="gradient-bg"></div>
            <div class="particles-container"></div>
            <div class="vignette"></div>
            <div class="candle-overlay"></div>
            <div class="light-rays"></div>
        </div>

        <!-- Landing page -->
        <div class="landing-page">
            <div class="landing-content">
                <svg class="app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e6c875" stroke-width="2" />
                    <path d="M50,10 L50,90" stroke="#e6c875" stroke-width="2" />
                    <path d="M30,30 L70,30" stroke="#e6c875" stroke-width="2" />
                    <path d="M20,50 L80,50" stroke="#e6c875" stroke-width="2" />
                    <path d="M30,70 L70,70" stroke="#e6c875" stroke-width="2" />
                    <circle cx="50" cy="50" r="5" fill="#e6c875" />
                </svg>
                <h1 class="app-title">THE SACRED ROSARY</h1>
                <p class="app-subtitle">A contemplative journey through prayer and meditation</p>
                
                <div class="rosary-selection">
                    <h2 class="rosary-selection-label">Select Mysteries</h2>
                    <div class="mystery-selection">
                        <button class="mystery-btn active" data-mystery="joyful">Joyful Mysteries</button>
                        <button class="mystery-btn" data-mystery="sorrowful">Sorrowful Mysteries</button>
                        <button class="mystery-btn" data-mystery="glorious">Glorious Mysteries</button>
                        <button class="mystery-btn" data-mystery="luminous">Luminous Mysteries</button>
                    </div>
                </div>
                
                <button class="start-btn">
                    <i class="fas fa-pray"></i> Begin Prayer
                </button>
                
                <p class="app-version">Version 1.0.0</p>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Prayer section -->
            <div class="prayer-section">
                <div class="prayer-backdrop"></div>
                <div class="prayer-scroll">
                    <div class="prayer-header">
                        <h2 class="prayer-title">The Sign of the Cross</h2>
                    </div>
                    <p class="prayer-instructions">Begin by making the Sign of the Cross</p>
                    <div class="prayer-text">
                        <p>In the name of the Father, and of the Son, and of the Holy Spirit. Amen.</p>
                    </div>
                    
                    <div class="rosary-progress">
                        <h3 class="progress-title">Opening Prayers</h3>
                        <div class="decade-indicator">
                            <div class="decade-dot active"></div>
                            <div class="decade-dot"></div>
                            <div class="decade-dot"></div>
                            <div class="decade-dot"></div>
                            <div class="decade-dot"></div>
                        </div>
                        <div class="bead-indicator">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
                
                <div class="prayer-controls">
                    <button class="prayer-btn settings-btn tooltip">
                        <i class="fas fa-cog"></i>
                        <span class="tooltip-text">Settings</span>
                    </button>
                    <button class="prayer-btn prev-btn">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="prayer-btn play-btn">
                        <i class="fas fa-play"></i> Play
                    </button>
                    <button class="prayer-btn next-btn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="volume-control">
                        <i class="fas fa-volume-up"></i>
                        <input type="range" class="volume-slider" min="0" max="100" value="50">
                    </div>
                    <button class="prayer-btn autoplay-toggle tooltip">
                        <i class="fas fa-sync-alt"></i>
                        <span class="tooltip-text">Auto-advance after prayer</span>
                    </button>
                </div>
            </div>
            
            <!-- 3D model section -->
            <div class="model-section">
                <div class="model-container">
                    <canvas id="model-canvas"></canvas>
                </div>
                
                <div class="model-controls">
                    <button class="model-btn tooltip" id="zoom-in-btn">
                        <i class="fas fa-search-plus"></i>
                        <span class="tooltip-text">Zoom In</span>
                    </button>
                    <button class="model-btn tooltip" id="zoom-out-btn">
                        <i class="fas fa-search-minus"></i>
                        <span class="tooltip-text">Zoom Out</span>
                    </button>
                    <button class="model-btn tooltip" id="reset-view-btn">
                        <i class="fas fa-sync"></i>
                        <span class="tooltip-text">Reset View</span>
                    </button>
                    <button class="model-btn tooltip" id="rotate-btn">
                        <i class="fas fa-redo"></i>
                        <span class="tooltip-text">Auto Rotate</span>
                    </button>
                    <button class="model-btn tooltip" id="light-btn">
                        <i class="fas fa-lightbulb"></i>
                        <span class="tooltip-text">Adjust Lighting</span>
                    </button>
                </div>
                
                <div class="mystery-info">
                    <h3 class="mystery-title">The Annunciation</h3>
                    <p class="mystery-description">The Angel Gabriel announces to Mary that she is to be the Mother of God. "Hail, full of grace, the Lord is with thee." (Luke 1:28)</p>
                    <p class="mystery-fruits">Fruit of the Mystery: Humility</p>
                </div>
            </div>
        </div>
        
        <!-- Settings modal -->
        <div class="settings-modal">
            <div class="settings-content">
                <div class="settings-header">
                    <h2 class="settings-title">Settings</h2>
                    <button class="close-settings">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="settings-sections">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Appearance</h3>
                        
                        <div class="setting-item">
                            <span class="setting-label">Dark Mode</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="dark-mode-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Text Size</span>
                            <div class="setting-control">
                                <input type="range" class="range-slider" id="text-size-slider" min="80" max="120" value="100">
                                <span id="text-size-value">100%</span>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Animation Effects</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="animation-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Liturgical Colors</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="liturgical-colors-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="settings-section-title">Audio</h3>
                        
                        <div class="setting-item">
                            <span class="setting-label">Music Volume</span>
                            <div class="setting-control">
                                <input type="range" class="range-slider" id="music-volume-slider" min="0" max="100" value="30">
                                <span id="music-volume-value">30%</span>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Voice Volume</span>
                            <div class="setting-control">
                                <input type="range" class="range-slider" id="voice-volume-slider" min="0" max="100" value="70">
                                <span id="voice-volume-value">70%</span>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Background Music</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="background-music-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Voice Guidance</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="voice-guidance-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="settings-section-title">3D Model</h3>
                        
                        <div class="setting-item">
                            <span class="setting-label">Model Quality</span>
                            <div class="setting-control">
                                <div class="select-container">
                                    <select class="settings-select" id="model-quality-select">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                    <div class="select-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Rotation Speed</span>
                            <div class="setting-control">
                                <input type="range" class="range-slider" id="rotation-speed-slider" min="0" max="100" value="50">
                                <span id="rotation-speed-value">50%</span>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Auto Rotation</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-rotation-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Highlight Active Bead</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="highlight-bead-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="settings-section-title">Prayer Options</h3>
                        
                        <div class="setting-item">
                            <span class="setting-label">Prayer Language</span>
                            <div class="setting-control">
                                <div class="select-container">
                                    <select class="settings-select" id="language-select">
                                        <option value="en" selected>English</option>
                                        <option value="la">Latin</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="it">Italian</option>
                                        <option value="pl">Polish</option>
                                        <option value="pt">Portuguese</option>
                                    </select>
                                    <div class="select-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Auto Advance</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-advance-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Meditation Duration</span>
                            <div class="setting-control">
                                <div class="select-container">
                                    <select class="settings-select" id="meditation-duration-select">
                                        <option value="none">None</option>
                                        <option value="short" selected>Short (5s)</option>
                                        <option value="medium">Medium (10s)</option>
                                        <option value="long">Long (15s)</option>
                                    </select>
                                    <div class="select-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <span class="setting-label">Show Scripture</span>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="show-scripture-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification -->
        <div class="notification">
            <div class="notification-header">
                <span class="notification-title">Notification Title</span>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="notification-message">Notification message goes here.</p>
        </div>
    </div>

    <script>
        // Define Global Application Constants & Variables
        const APP = {
            // Configuration
            CONFIG: {
                DEFAULT_MYSTERY_TYPE: 'joyful',
                AUTO_ADVANCE_DELAY: 1000, // ms to wait after audio finishes before advancing
                DEFAULT_VOLUME: 0.5,
                MODEL_ROTATION_SPEED: 0.005,
                MODEL_URL: 'https://raw.githubusercontent.com/thesacredrosary/thesacredrosary/main/rosary.fbx', // Replace with your actual GitHub URL
                PARTICLE_COUNT: 50,
                FADE_DURATION: 800, // ms
                PRAYER_TEXT_BASE_SIZE: 16, // px
                LIGHT_INTENSITY: 1.5,
                AMBIENT_LIGHT_INTENSITY: 0.4,
                MODEL_SCALE: 1.0,
                DEFAULT_CAMERA_POSITION: { x: 0, y: 0, z: 5 },
                CAMERA_FOV: 45,
                DEFAULT_BACKGROUND_COLOR: 0x0a1015,
                MODEL_AUTO_ROTATION: false,
                ANIMATION_ENABLED: true,
                DEBUG_MODE: false,
            },
            
            // State
            STATE: {
                currentPrayerIndex: 0,
                currentMysteryType: 'joyful',
                isPlaying: false,
                isAutoAdvanceEnabled: false,
                isModelLoaded: false,
                isAppInitialized: false,
                autoRotationEnabled: false,
                musicVolume: 0.3,
                voiceVolume: 0.7,
                activeLanguage: 'en',
                darkModeEnabled: true,
                textSizeMultiplier: 1.0,
                meditationDuration: 'short',
                liturgicalSeason: 'ordinary', // Default to Ordinary Time
                modelQuality: 'medium',
                rotationSpeed: 0.5,
                isModalOpen: false,
                loadingProgress: 0,
            },
            
            // DOM Elements (will be populated on init)
            ELEMENTS: {},
            
            // Three.js objects
            THREE: {
                scene: null,
                camera: null,
                renderer: null,
                model: null,
                lights: {},
                controls: null,
                animationMixers: [],
                clock: null,
                raycaster: null,
                mouse: null,
            },
            
            // Audio objects
            AUDIO: {
                backgroundMusic: null,
                prayerAudio: null,
                effects: {},
            },
            
            // Content data
            DATA: {
                mysteries: {},
                prayers: {},
                rosarySequence: [],
                liturgicalCalendar: {},
                translations: {},
            },
            
            // Particle system
            PARTICLES: {
                particles: [],
                canvas: null,
                ctx: null,
            },
            
            // Utility functions
            UTILS: {},
            
            // Event handlers
            EVENTS: {},
            
            // Initialization
            INIT: {},
            
            // Main functionality
            CORE: {},
            
            // 3D model handling
            MODEL: {},
            
            // Particle system
            PARTICLE_SYSTEM: {},
            
            // Settings management
            SETTINGS: {},
            
            // User interface updates
            UI: {},
            
            // Language and localization
            LANGUAGE: {},
        };

        // Initialize and Register DOM Elements
        APP.INIT.registerDOMElements = function() {
            // Main sections
            APP.ELEMENTS.appContainer = document.querySelector('.app-container');
            APP.ELEMENTS.loadingOverlay = document.querySelector('.loading-overlay');
            APP.ELEMENTS.loadingBar = document.querySelector('.loading-bar');
            APP.ELEMENTS.landingPage = document.querySelector('.landing-page');
            APP.ELEMENTS.mainContent = document.querySelector('.main-content');
            APP.ELEMENTS.prayerSection = document.querySelector('.prayer-section');
            APP.ELEMENTS.modelSection = document.querySelector('.model-section');
            
            // Background effects
            APP.ELEMENTS.backgroundEffects = document.querySelector('.background-effects');
            APP.ELEMENTS.candleOverlay = document.querySelector('.candle-overlay');
            APP.ELEMENTS.lightRays = document.querySelector('.light-rays');
            APP.ELEMENTS.particlesContainer = document.querySelector('.particles-container');
            
            // Prayer elements
            APP.ELEMENTS.prayerScroll = document.querySelector('.prayer-scroll');
            APP.ELEMENTS.prayerTitle = document.querySelector('.prayer-title');
            APP.ELEMENTS.prayerInstructions = document.querySelector('.prayer-instructions');
            APP.ELEMENTS.prayerText = document.querySelector('.prayer-text');
            APP.ELEMENTS.progressTitle = document.querySelector('.progress-title');
            APP.ELEMENTS.decadeIndicator = document.querySelector('.decade-indicator');
            APP.ELEMENTS.decadeDots = document.querySelectorAll('.decade-dot');
            APP.ELEMENTS.beadIndicator = document.querySelector('.bead-indicator');
            
            // Controls
            APP.ELEMENTS.prayerControls = document.querySelector('.prayer-controls');
            APP.ELEMENTS.prevBtn = document.querySelector('.prev-btn');
            APP.ELEMENTS.playBtn = document.querySelector('.play-btn');
            APP.ELEMENTS.nextBtn = document.querySelector('.next-btn');
            APP.ELEMENTS.settingsBtn = document.querySelector('.settings-btn');
            APP.ELEMENTS.autoplayToggle = document.querySelector('.autoplay-toggle');
            APP.ELEMENTS.volumeSlider = document.querySelector('.volume-slider');
            
            // Model elements
            APP.ELEMENTS.modelCanvas = document.getElementById('model-canvas');
            APP.ELEMENTS.modelControls = document.querySelector('.model-controls');
            APP.ELEMENTS.zoomInBtn = document.getElementById('zoom-in-btn');
            APP.ELEMENTS.zoomOutBtn = document.getElementById('zoom-out-btn');
            APP.ELEMENTS.resetViewBtn = document.getElementById('reset-view-btn');
            APP.ELEMENTS.rotateBtn = document.getElementById('rotate-btn');
            APP.ELEMENTS.lightBtn = document.getElementById('light-btn');
            APP.ELEMENTS.mysteryInfo = document.querySelector('.mystery-info');
            
            // Landing page elements
            APP.ELEMENTS.mysteryBtns = document.querySelectorAll('.mystery-btn');
            APP.ELEMENTS.startBtn = document.querySelector('.start-btn');
            
            // Settings modal elements
            APP.ELEMENTS.settingsModal = document.querySelector('.settings-modal');
            APP.ELEMENTS.closeSettingsBtn = document.querySelector('.close-settings');
            APP.ELEMENTS.darkModeToggle = document.getElementById('dark-mode-toggle');
            APP.ELEMENTS.textSizeSlider = document.getElementById('text-size-slider');
            APP.ELEMENTS.textSizeValue = document.getElementById('text-size-value');
            APP.ELEMENTS.animationToggle = document.getElementById('animation-toggle');
            APP.ELEMENTS.liturgicalColorsToggle = document.getElementById('liturgical-colors-toggle');
            APP.ELEMENTS.musicVolumeSlider = document.getElementById('music-volume-slider');
            APP.ELEMENTS.musicVolumeValue = document.getElementById('music-volume-value');
            APP.ELEMENTS.voiceVolumeSlider = document.getElementById('voice-volume-slider');
            APP.ELEMENTS.voiceVolumeValue = document.getElementById('voice-volume-value');
            APP.ELEMENTS.backgroundMusicToggle = document.getElementById('background-music-toggle');
            APP.ELEMENTS.voiceGuidanceToggle = document.getElementById('voice-guidance-toggle');
            APP.ELEMENTS.modelQualitySelect = document.getElementById('model-quality-select');
            APP.ELEMENTS.rotationSpeedSlider = document.getElementById('rotation-speed-slider');
            APP.ELEMENTS.rotationSpeedValue = document.getElementById('rotation-speed-value');
            APP.ELEMENTS.autoRotationToggle = document.getElementById('auto-rotation-toggle');
            APP.ELEMENTS.highlightBeadToggle = document.getElementById('highlight-bead-toggle');
            APP.ELEMENTS.languageSelect = document.getElementById('language-select');
            APP.ELEMENTS.autoAdvanceToggle = document.getElementById('auto-advance-toggle');
            APP.ELEMENTS.meditationDurationSelect = document.getElementById('meditation-duration-select');
            APP.ELEMENTS.showScriptureToggle = document.getElementById('show-scripture-toggle');
            
            // Notification elements
            APP.ELEMENTS.notification = document.querySelector('.notification');
            APP.ELEMENTS.notificationTitle = document.querySelector('.notification-title');
            APP.ELEMENTS.notificationMessage = document.querySelector('.notification-message');
            APP.ELEMENTS.notificationClose = document.querySelector('.notification-close');
        };

        // Initialize the app
        APP.INIT.initialize = function() {
            // Register DOM elements
            APP.INIT.registerDOMElements();
            
            // Initialize data
            APP.INIT.initializeData();
            
            // Set up event handlers
            APP.EVENTS.setupEventListeners();
            
            // Initialize the 3D scene
            APP.MODEL.initializeScene();
            
            // Initialize the particle system
            APP.PARTICLE_SYSTEM.initialize();
            
            // Apply settings
            APP.SETTINGS.applySettings();
            
            // Setup audio
            APP.INIT.setupAudio();
            
            // Set liturgical color based on current date
            APP.CORE.setLiturgicalColors();
            
            // Create rosary sequence
            APP.CORE.createRosarySequence(APP.STATE.currentMysteryType);
            
            // Start loading assets
            APP.INIT.loadAssets();
        };

        // Initialize data (mysteries, prayers, etc.)
        APP.INIT.initializeData = function() {
            // Define mysteries
            APP.DATA.mysteries = {
                joyful: [
                    {
                        title: "The Annunciation",
                        description: "The Angel Gabriel announces to Mary that she is to be the Mother of God. \"Hail, full of grace, the Lord is with thee.\" (Luke 1:28)",
                        fruits: "Fruit of the Mystery: Humility",
                        scripture: "The angel Gabriel was sent from God to a city of Galilee named Nazareth, to a virgin betrothed to a man whose name was Joseph, of the house of David; and the virgin's name was Mary. And he came to her and said, \"Hail, full of grace, the Lord is with you!\" But she was greatly troubled at the saying, and considered in her mind what sort of greeting this might be. And the angel said to her, \"Do not be afraid, Mary, for you have found favor with God. And behold, you will conceive in your womb and bear a son, and you shall call his name Jesus. He will be great, and will be called the Son of the Most High; and the Lord God will give to him the throne of his father David, and he will reign over the house of Jacob for ever; and of his kingdom there will be no end.\" (Luke 1:26-33)",
                        audio: "mysteries/joyful_1.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 }, // Default position
                        modelRotation: { x: 0, y: 0, z: 0 }, // Default rotation
                        highlightPart: "bead1" // ID of the part to highlight in the model
                    },
                    {
                        title: "The Visitation",
                        description: "Mary visits her cousin Elizabeth, who is pregnant with John the Baptist. (Luke 1:41-42)",
                        fruits: "Fruit of the Mystery: Love of Neighbor",
                        scripture: "In those days Mary arose and went with haste into the hill country, to a city of Judah, and she entered the house of Zechariah and greeted Elizabeth. And when Elizabeth heard the greeting of Mary, the babe leaped in her womb; and Elizabeth was filled with the Holy Spirit and she exclaimed with a loud cry, \"Blessed are you among women, and blessed is the fruit of your womb! And why is this granted me, that the mother of my Lord should come to me? For behold, when the voice of your greeting came to my ears, the babe in my womb leaped for joy. And blessed is she who believed that there would be a fulfillment of what was spoken to her from the Lord.\" (Luke 1:39-45)",
                        audio: "mysteries/joyful_2.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead2"
                    },
                    {
                        title: "The Nativity",
                        description: "Mary gives birth to Jesus in a stable in Bethlehem. (Luke 2:6-7)",
                        fruits: "Fruit of the Mystery: Poverty, Detachment from the World",
                        scripture: "And while they were there, the time came for her to be delivered. And she gave birth to her first-born son and wrapped him in swaddling cloths, and laid him in a manger, because there was no place for them in the inn. And in that region there were shepherds out in the field, keeping watch over their flock by night. And an angel of the Lord appeared to them, and the glory of the Lord shone around them, and they were filled with fear. And the angel said to them, \"Be not afraid; for behold, I bring you good news of a great joy which will come to all the people; for to you is born this day in the city of David a Savior, who is Christ the Lord.\" (Luke 2:6-11)",
                        audio: "mysteries/joyful_3.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead3"
                    },
                    {
                        title: "The Presentation in the Temple",
                        description: "Mary and Joseph present Jesus in the Temple. (Luke 2:22-23)",
                        fruits: "Fruit of the Mystery: Obedience",
                        scripture: "And when the time came for their purification according to the law of Moses, they brought him up to Jerusalem to present him to the Lord (as it is written in the law of the Lord, \"Every male that opens the womb shall be called holy to the Lord\") and to offer a sacrifice according to what is said in the law of the Lord, \"a pair of turtledoves, or two young pigeons.\" Now there was a man in Jerusalem, whose name was Simeon, and this man was righteous and devout, looking for the consolation of Israel, and the Holy Spirit was upon him. And it had been revealed to him by the Holy Spirit that he should not see death before he had seen the Lord's Christ. (Luke 2:22-26)",
                        audio: "mysteries/joyful_4.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead4"
                    },
                    {
                        title: "The Finding of Jesus in the Temple",
                        description: "After three days, Mary and Joseph find the young Jesus teaching in the Temple. (Luke 2:46-47)",
                        fruits: "Fruit of the Mystery: Joy in Finding Jesus",
                        scripture: "After three days they found him in the temple, sitting among the teachers, listening to them and asking them questions; and all who heard him were amazed at his understanding and his answers. And when they saw him they were astonished; and his mother said to him, \"Son, why have you treated us so? Behold, your father and I have been looking for you anxiously.\" And he said to them, \"How is it that you sought me? Did you not know that I must be in my Father's house?\" (Luke 2:46-49)",
                        audio: "mysteries/joyful_5.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead5"
                    }
                ],
                sorrowful: [
                    {
                        title: "The Agony in the Garden",
                        description: "Jesus prays in the Garden of Gethsemane on the night before His death. (Luke 22:44-45)",
                        fruits: "Fruit of the Mystery: Sorrow for Sin, Conformity to the Will of God",
                        scripture: "Then Jesus went with them to a place called Gethsemane, and he said to his disciples, \"Sit here, while I go yonder and pray.\" And taking with him Peter and the two sons of Zebedee, he began to be sorrowful and troubled. Then he said to them, \"My soul is very sorrowful, even to death; remain here, and watch with me.\" And going a little farther he fell on his face and prayed, \"My Father, if it be possible, let this cup pass from me; nevertheless, not as I will, but as thou wilt.\" (Matthew 26:36-39)",
                        audio: "mysteries/sorrowful_1.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead6"
                    },
                    {
                        title: "The Scourging at the Pillar",
                        description: "Jesus is scourged at the pillar by order of Pontius Pilate. (John 19:1)",
                        fruits: "Fruit of the Mystery: Mortification, Purity",
                        scripture: "Then Pilate took Jesus and scourged him. And the soldiers plaited a crown of thorns, and put it on his head, and arrayed him in a purple robe; they came up to him, saying, \"Hail, King of the Jews!\" and struck him with their hands. (John 19:1-3)",
                        audio: "mysteries/sorrowful_2.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead7"
                    },
                    {
                        title: "The Crowning with Thorns",
                        description: "Jesus is mocked and crowned with thorns. (Matthew 27:29)",
                        fruits: "Fruit of the Mystery: Moral Courage",
                        scripture: "And they stripped him and put a scarlet robe upon him, and plaiting a crown of thorns they put it on his head, and put a reed in his right hand. And kneeling before him they mocked him, saying, \"Hail, King of the Jews!\" And they spat upon him, and took the reed and struck him on the head. (Matthew 27:28-30)",
                        audio: "mysteries/sorrowful_3.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead8"
                    },
                    {
                        title: "The Carrying of the Cross",
                        description: "Jesus carries His cross to Calvary. (John 19:17)",
                        fruits: "Fruit of the Mystery: Patience",
                        scripture: "So they took Jesus, and he went out, bearing his own cross, to the place called the place of a skull, which is called in Hebrew Golgotha. (John 19:17)",
                        audio: "mysteries/sorrowful_4.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead9"
                    },
                    {
                        title: "The Crucifixion",
                        description: "Jesus is nailed to the cross and dies after three hours of agony. (Luke 23:46)",
                        fruits: "Fruit of the Mystery: Perseverance",
                        scripture: "And when they came to the place which is called The Skull, there they crucified him, and the criminals, one on the right and one on the left. And Jesus said, \"Father, forgive them; for they know not what they do.\" And they cast lots to divide his garments. And the people stood by, watching; but the rulers scoffed at him, saying, \"He saved others; let him save himself, if he is the Christ of God, his Chosen One!\" (Luke 23:33-35)",
                        audio: "mysteries/sorrowful_5.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead10"
                    }
                ],
                glorious: [
                    {
                        title: "The Resurrection",
                        description: "Jesus rises from the dead three days after His crucifixion. (Mark 16:6)",
                        fruits: "Fruit of the Mystery: Faith",
                        scripture: "But on the first day of the week, at early dawn, they went to the tomb, taking the spices which they had prepared. And they found the stone rolled away from the tomb, but when they went in they did not find the body of the Lord Jesus. While they were perplexed about this, behold, two men stood by them in dazzling apparel; and as they were frightened and bowed their faces to the ground, the men said to them, \"Why do you seek the living among the dead? He is not here, but has risen.\" (Luke 24:1-5)",
                        audio: "mysteries/glorious_1.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead11"
                    },
                    {
                        title: "The Ascension",
                        description: "Jesus ascends into Heaven forty days after His resurrection. (Acts 1:9-11)",
                        fruits: "Fruit of the Mystery: Hope, Desire for Heaven",
                        scripture: "And when he had said this, as they were looking on, he was lifted up, and a cloud took him out of their sight. And while they were gazing into heaven as he went, behold, two men stood by them in white robes, and said, \"Men of Galilee, why do you stand looking into heaven? This Jesus, who was taken up from you into heaven, will come in the same way as you saw him go into heaven.\" (Acts 1:9-11)",
                        audio: "mysteries/glorious_2.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead12"
                    },
                    {
                        title: "The Descent of the Holy Spirit",
                        description: "The Holy Spirit descends upon Mary and the Apostles. (Acts 2:3-4)",
                        fruits: "Fruit of the Mystery: Wisdom, Love of God",
                        scripture: "When the day of Pentecost had come, they were all together in one place. And suddenly a sound came from heaven like the rush of a mighty wind, and it filled all the house where they were sitting. And there appeared to them tongues as of fire, distributed and resting on each one of them. And they were all filled with the Holy Spirit and began to speak in other tongues, as the Spirit gave them utterance. (Acts 2:1-4)",
                        audio: "mysteries/glorious_3.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead13"
                    },
                    {
                        title: "The Assumption of Mary",
                        description: "At the end of her life, Mary is taken body and soul into Heaven.",
                        fruits: "Fruit of the Mystery: Grace of a Happy Death",
                        scripture: "\"For behold, henceforth all generations will call me blessed; for he who is mighty has done great things for me, and holy is his name.\" (Luke 1:48-49)",
                        audio: "mysteries/glorious_4.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead14"
                    },
                    {
                        title: "The Coronation of Mary",
                        description: "Mary is crowned Queen of Heaven and Earth.",
                        fruits: "Fruit of the Mystery: Trust in Mary's Intercession",
                        scripture: "And a great portent appeared in heaven, a woman clothed with the sun, with the moon under her feet, and on her head a crown of twelve stars. (Revelation 12:1)",
                        audio: "mysteries/glorious_5.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead15"
                    }
                ],
                luminous: [
                    {
                        title: "The Baptism in the Jordan",
                        description: "Jesus is baptized by John in the Jordan River. (Matthew 3:16-17)",
                        fruits: "Fruit of the Mystery: Openness to the Holy Spirit",
                        scripture: "And when Jesus was baptized, he went up immediately from the water, and behold, the heavens were opened and he saw the Spirit of God descending like a dove, and alighting on him; and lo, a voice from heaven, saying, \"This is my beloved Son, with whom I am well pleased.\" (Matthew 3:16-17)",
                        audio: "mysteries/luminous_1.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead16"
                    },
                    {
                        title: "The Wedding at Cana",
                        description: "Jesus performs His first miracle at the wedding feast in Cana. (John 2:11)",
                        fruits: "Fruit of the Mystery: To Jesus through Mary",
                        scripture: "On the third day there was a marriage at Cana in Galilee, and the mother of Jesus was there; Jesus also was invited to the marriage, with his disciples. When the wine failed, the mother of Jesus said to him, \"They have no wine.\" And Jesus said to her, \"O woman, what have you to do with me? My hour has not yet come.\" His mother said to the servants, \"Do whatever he tells you.\" (John 2:1-5)",
                        audio: "mysteries/luminous_2.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead17"
                    },
                    {
                        title: "The Proclamation of the Kingdom",
                        description: "Jesus proclaims the Kingdom of God and calls all to conversion. (Mark 1:15)",
                        fruits: "Fruit of the Mystery: Repentance, Trust in God",
                        scripture: "The time is fulfilled, and the kingdom of God is at hand; repent, and believe in the gospel. (Mark 1:15)",
                        audio: "mysteries/luminous_3.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead18"
                    },
                    {
                        title: "The Transfiguration",
                        description: "Jesus is transfigured on Mount Tabor. (Matthew 17:2)",
                        fruits: "Fruit of the Mystery: Desire for Holiness",
                        scripture: "And after six days Jesus took with him Peter and James and John his brother, and led them up a high mountain apart. And he was transfigured before them, and his face shone like the sun, and his garments became white as light. And behold, there appeared to them Moses and Elijah, talking with him. (Matthew 17:1-3)",
                        audio: "mysteries/luminous_4.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead19"
                    },
                    {
                        title: "The Institution of the Eucharist",
                        description: "Jesus institutes the Eucharist at the Last Supper. (Matthew 26:26-28)",
                        fruits: "Fruit of the Mystery: Adoration",
                        scripture: "Now as they were eating, Jesus took bread, and blessed, and broke it, and gave it to the disciples and said, \"Take, eat; this is my body.\" And he took a cup, and when he had given thanks he gave it to them, saying, \"Drink of it, all of you; for this is my blood of the covenant, which is poured out for many for the forgiveness of sins.\" (Matthew 26:26-28)",
                        audio: "mysteries/luminous_5.mp3",
                        modelPosition: { x: 0, y: 0, z: 0 },
                        modelRotation: { x: 0, y: 0, z: 0 },
                        highlightPart: "bead20"
                    }
                ]
            };
            
            // Define prayers
            APP.DATA.prayers = {
                signOfCross: {
                    title: "The Sign of the Cross",
                    instructions: "Begin by making the Sign of the Cross",
                    text: "In the name of the Father, and of the Son, and of the Holy Spirit. Amen.",
                    audio: "prayers/sign_of_cross.mp3",
                    duration: 5000 // Estimated audio duration in ms
                },
                apostlesCreed: {
                    title: "The Apostles' Creed",
                    instructions: "Recite the Apostles' Creed",
                    text: "I believe in God, the Father almighty, Creator of heaven and earth, and in Jesus Christ, His only Son, our Lord, who was conceived by the Holy Spirit, born of the Virgin Mary, suffered under Pontius Pilate, was crucified, died and was buried; He descended into hell; on the third day He rose again from the dead; He ascended into heaven, and is seated at the right hand of God the Father almighty; from there He will come to judge the living and the dead. I believe in the Holy Spirit, the holy catholic Church, the communion of saints, the forgiveness of sins, the resurrection of the body, and life everlasting. Amen.",
                    audio: "prayers/apostles_creed.mp3",
                    duration: 30000
                },
                ourFather: {
                    title: "Our Father",
                    instructions: "Recite the Our Father prayer",
                    text: "Our Father, who art in heaven, hallowed be Thy name; Thy kingdom come; Thy will be done on earth as it is in heaven. Give us this day our daily bread; and forgive us our trespasses as we forgive those who trespass against us; and lead us not into temptation, but deliver us from evil. Amen.",
                    audio: "prayers/our_father.mp3",
                    duration: 20000
                },
                hailMary: {
                    title: "Hail Mary",
                    instructions: "Recite the Hail Mary prayer",
                    text: "Hail Mary, full of grace. The Lord is with thee. Blessed art thou amongst women, and blessed is the fruit of thy womb, Jesus. Holy Mary, Mother of God, pray for us sinners, now and at the hour of our death. Amen.",
                    audio: "prayers/hail_mary.mp3",
                    duration: 15000
                },
                gloryBe: {
                    title: "Glory Be",
                    instructions: "Recite the Glory Be prayer",
                    text: "Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen.",
                    audio: "prayers/glory_be.mp3",
                    duration: 10000
                },
                fatimaPrayer: {
                    title: "Fatima Prayer",
                    instructions: "Recite the Fatima Prayer",
                    text: "O my Jesus, forgive us our sins, save us from the fires of hell, lead all souls to Heaven, especially those in most need of Thy mercy.",
                    audio: "prayers/fatima_prayer.mp3",
                    duration: 10000
                },
                hailHolyQueen: {
                    title: "Hail, Holy Queen",
                    instructions: "Conclude with the Hail, Holy Queen prayer",
                    text: "Hail, holy Queen, Mother of mercy, our life, our sweetness and our hope. To thee do we cry, poor banished children of Eve. To thee do we send up our sighs, mourning and weeping in this valley of tears. Turn, then, most gracious advocate, thine eyes of mercy toward us, and after this, our exile, show unto us the blessed fruit of thy womb, Jesus. O clement, O loving, O sweet Virgin Mary. Pray for us, O holy Mother of God. That we may be made worthy of the promises of Christ.",
                    audio: "prayers/hail_holy_queen.mp3",
                    duration: 25000
                },
                finalPrayer: {
                    title: "Closing Prayer",
                    instructions: "Finish with the closing prayer",
                    text: "Let us pray. O God, whose Only Begotten Son, by his life, Death, and Resurrection, has purchased for us the rewards of eternal life, grant, we beseech thee, that while meditating on these mysteries of the most holy Rosary of the Blessed Virgin Mary, we may imitate what they contain and obtain what they promise, through the same Christ our Lord. Amen.",
                    audio: "prayers/closing_prayer.mp3",
                    duration: 20000
                }
            };
            
            // Define liturgical calendar (simplified for demonstration)
                APP.DATA.liturgicalCalendar = {
                    // Format: month/day: season
                    // 0 = Ordinary Time (green)
                    // 1 = Advent (purple)
                    // 2 = Christmas (white/gold)
                    // 3 = Lent (purple)
                    // 4 = Easter (white/gold)
                    // 5 = Feast days (red)
                    
                    // Advent (approximate - starts 4 Sundays before Christmas)
                    "11-27": 1, "11-28": 1, "11-29": 1, "11-30": 1,
                    "12-1": 1, "12-2": 1, "12-3": 1, "12-4": 1, "12-5": 1, "12-6": 1, "12-7": 1,
                    "12-8": 1, "12-9": 1, "12-10": 1, "12-11": 1, "12-12": 1, "12-13": 1, "12-14": 1,
                    "12-15": 1, "12-16": 1, "12-17": 1, "12-18": 1, "12-19": 1, "12-20": 1, "12-21": 1,
                    "12-22": 1, "12-23": 1, "12-24": 1,
                    
                    // Christmas
                    "12-25": 2, "12-26": 2, "12-27": 2, "12-28": 2, "12-29": 2, "12-30": 2, "12-31": 2,
                    "1-1": 2, "1-2": 2, "1-3": 2, "1-4": 2, "1-5": 2, "1-6": 2, "1-7": 2, "1-8": 2, "1-9": 2,
                    
                    // Ash Wednesday and Lent (approximate - would need adjustment yearly)
                    "2-17": 3, "2-18": 3, "2-19": 3, "2-20": 3, "2-21": 3, "2-22": 3, "2-23": 3,
                    "2-24": 3, "2-25": 3, "2-26": 3, "2-27": 3, "2-28": 3, "2-29": 3, "3-1": 3,
                    "3-2": 3, "3-3": 3, "3-4": 3, "3-5": 3, "3-6": 3, "3-7": 3, "3-8": 3,
                    "3-9": 3, "3-10": 3, "3-11": 3, "3-12": 3, "3-13": 3, "3-14": 3, "3-15": 3,
                    "3-16": 3, "3-17": 3, "3-18": 3, "3-19": 3, "3-20": 3, "3-21": 3, "3-22": 3,
                    "3-23": 3, "3-24": 3, "3-25": 3, "3-26": 3, "3-27": 3, "3-28": 3, "3-29": 3,
                    "3-30": 3, "3-31": 3, "4-1": 3, "4-2": 3,
                    
                    // Easter (approximate - would need adjustment yearly)
                    "4-3": 4, "4-4": 4, "4-5": 4, "4-6": 4, "4-7": 4, "4-8": 4, "4-9": 4,
                    "4-10": 4, "4-11": 4, "4-12": 4, "4-13": 4, "4-14": 4, "4-15": 4, "4-16": 4,
                    "4-17": 4, "4-18": 4, "4-19": 4, "4-20": 4, "4-21": 4, "4-22": 4, "4-23": 4,
                    
                    // Some major feast days (simplified)
                    "3-17": 5, // St. Patrick's Day
                    "3-19": 5, // St. Joseph
                    "6-29": 5, // Sts. Peter and Paul
                    "8-15": 5, // Assumption
                    "11-1": 5, // All Saints
                };
            };

        // Set up event listeners
        APP.EVENTS.setupEventListeners = function() {
            // Landing page events
            APP.ELEMENTS.mysteryBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    APP.ELEMENTS.mysteryBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    APP.STATE.currentMysteryType = btn.dataset.mystery;
                });
            });
            
            APP.ELEMENTS.startBtn.addEventListener('click', () => {
                APP.CORE.startRosary();
            });
            
            // Prayer control events
            APP.ELEMENTS.prevBtn.addEventListener('click', () => {
                APP.CORE.prevPrayer();
            });
            
            APP.ELEMENTS.nextBtn.addEventListener('click', () => {
                APP.CORE.nextPrayer();
            });
            
            APP.ELEMENTS.playBtn.addEventListener('click', () => {
                APP.CORE.togglePlay();
            });
            
            APP.ELEMENTS.autoplayToggle.addEventListener('click', () => {
                APP.STATE.isAutoAdvanceEnabled = !APP.STATE.isAutoAdvanceEnabled;
                APP.ELEMENTS.autoplayToggle.classList.toggle('active', APP.STATE.isAutoAdvanceEnabled);
                APP.UI.showNotification('Auto-advance', 
                    APP.STATE.isAutoAdvanceEnabled ? 'Auto-advance enabled' : 'Auto-advance disabled');
            });
            
            APP.ELEMENTS.volumeSlider.addEventListener('input', (e) => {
                const volume = parseFloat(e.target.value) / 100;
                APP.CORE.setVolume(volume);
            });
            
            // Model control events
            APP.ELEMENTS.zoomInBtn.addEventListener('click', () => {
                APP.MODEL.zoomIn();
            });
            
            APP.ELEMENTS.zoomOutBtn.addEventListener('click', () => {
                APP.MODEL.zoomOut();
            });
            
            APP.ELEMENTS.resetViewBtn.addEventListener('click', () => {
                APP.MODEL.resetView();
            });
            
            APP.ELEMENTS.rotateBtn.addEventListener('click', () => {
                APP.MODEL.toggleAutoRotation();
            });
            
            APP.ELEMENTS.lightBtn.addEventListener('click', () => {
                APP.MODEL.cycleLighting();
            });
            
            // Settings events
            APP.ELEMENTS.settingsBtn.addEventListener('click', () => {
                APP.SETTINGS.toggleSettingsModal();
            });
            
            APP.ELEMENTS.closeSettingsBtn.addEventListener('click', () => {
                APP.SETTINGS.toggleSettingsModal();
            });
            
            // Settings controls
            APP.ELEMENTS.darkModeToggle.addEventListener('change', (e) => {
                APP.STATE.darkModeEnabled = e.target.checked;
                APP.SETTINGS.applySettings();
            });
            
            APP.ELEMENTS.textSizeSlider.addEventListener('input', (e) => {
                APP.STATE.textSizeMultiplier = parseInt(e.target.value) / 100;
                APP.ELEMENTS.textSizeValue.textContent = `${e.target.value}%`;
                APP.SETTINGS.applySettings();
            });
            
            APP.ELEMENTS.animationToggle.addEventListener('change', (e) => {
                APP.CONFIG.ANIMATION_ENABLED = e.target.checked;
                APP.SETTINGS.applySettings();
            });
            
            APP.ELEMENTS.liturgicalColorsToggle.addEventListener('change', (e) => {
                if (e.target.checked) {
                    APP.CORE.setLiturgicalColors();
                } else {
                    // Reset to default colors
                    APP.CORE.setThemeColors('ordinary');
                }
            });
            
            APP.ELEMENTS.musicVolumeSlider.addEventListener('input', (e) => {
                APP.STATE.musicVolume = parseInt(e.target.value) / 100;
                APP.ELEMENTS.musicVolumeValue.textContent = `${e.target.value}%`;
                if (APP.AUDIO.backgroundMusic) {
                    APP.AUDIO.backgroundMusic.volume = APP.STATE.musicVolume;
                }
            });
            
            APP.ELEMENTS.voiceVolumeSlider.addEventListener('input', (e) => {
                APP.STATE.voiceVolume = parseInt(e.target.value) / 100;
                APP.ELEMENTS.voiceVolumeValue.textContent = `${e.target.value}%`;
                if (APP.AUDIO.prayerAudio) {
                    APP.AUDIO.prayerAudio.volume = APP.STATE.voiceVolume;
                }
            });
            
            APP.ELEMENTS.backgroundMusicToggle.addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (APP.AUDIO.backgroundMusic) {
                        APP.AUDIO.backgroundMusic.play();
                    }
                } else {
                    if (APP.AUDIO.backgroundMusic) {
                        APP.AUDIO.backgroundMusic.pause();
                    }
                }
            });
            
            APP.ELEMENTS.voiceGuidanceToggle.addEventListener('change', (e) => {
                // This will be used to control whether prayer audio plays
                APP.STATE.voiceGuidanceEnabled = e.target.checked;
            });
            
            APP.ELEMENTS.modelQualitySelect.addEventListener('change', (e) => {
                APP.STATE.modelQuality = e.target.value;
                // Reload the model with new quality if already loaded
                if (APP.STATE.isModelLoaded) {
                    APP.MODEL.setModelQuality(APP.STATE.modelQuality);
                }
            });
            
            APP.ELEMENTS.rotationSpeedSlider.addEventListener('input', (e) => {
                APP.STATE.rotationSpeed = parseInt(e.target.value) / 100;
                APP.ELEMENTS.rotationSpeedValue.textContent = `${e.target.value}%`;
                APP.CONFIG.MODEL_ROTATION_SPEED = 0.001 + (APP.STATE.rotationSpeed * 0.01);
            });
            
            APP.ELEMENTS.autoRotationToggle.addEventListener('change', (e) => {
                APP.STATE.autoRotationEnabled = e.target.checked;
                APP.MODEL.setAutoRotation(APP.STATE.autoRotationEnabled);
            });
            
            APP.ELEMENTS.highlightBeadToggle.addEventListener('change', (e) => {
                // This will be used to control whether beads are highlighted in the 3D model
                APP.STATE.highlightBeadEnabled = e.target.checked;
            });
            
            APP.ELEMENTS.languageSelect.addEventListener('change', (e) => {
                APP.STATE.activeLanguage = e.target.value;
                // Update prayers language
                APP.LANGUAGE.setLanguage(APP.STATE.activeLanguage);
            });
            
            APP.ELEMENTS.autoAdvanceToggle.addEventListener('change', (e) => {
                APP.STATE.isAutoAdvanceEnabled = e.target.checked;
                APP.ELEMENTS.autoplayToggle.classList.toggle('active', APP.STATE.isAutoAdvanceEnabled);
            });
            
            APP.ELEMENTS.meditationDurationSelect.addEventListener('change', (e) => {
                APP.STATE.meditationDuration = e.target.value;
            });
            
            APP.ELEMENTS.showScriptureToggle.addEventListener('change', (e) => {
                // This will be used to control whether scripture is shown
                APP.STATE.showScriptureEnabled = e.target.checked;
                APP.UI.updatePrayerDisplay();
            });
            
            // Notification close event
            APP.ELEMENTS.notificationClose.addEventListener('click', () => {
                APP.UI.hideNotification();
            });
            
            // Window resize event
            window.addEventListener('resize', () => {
                if (APP.THREE.camera && APP.THREE.renderer) {
                    APP.THREE.camera.aspect = APP.ELEMENTS.modelCanvas.clientWidth / APP.ELEMENTS.modelCanvas.clientHeight;
                    APP.THREE.camera.updateProjectionMatrix();
                    APP.THREE.renderer.setSize(APP.ELEMENTS.modelCanvas.clientWidth, APP.ELEMENTS.modelCanvas.clientHeight);
                }
            });
            
            // Canvas events for model interaction
            APP.ELEMENTS.modelCanvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (e.deltaY < 0) {
                    APP.MODEL.zoomIn();
                } else {
                    APP.MODEL.zoomOut();
                }
            });
            
            // For mobile
            let touchStartY;
            APP.ELEMENTS.modelCanvas.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            });
            
            APP.ELEMENTS.modelCanvas.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const diff = touchStartY - touchY;
                
                if (Math.abs(diff) > 10) {
                    if (diff > 0) {
                        APP.MODEL.zoomIn();
                    } else {
                        APP.MODEL.zoomOut();
                    }
                    touchStartY = touchY;
                }
            });
        };

        // Fix 1: Add this code right before APP.INIT.loadAssets in the existing codebase
// This creates a fallback mechanism to proceed even if model loading fails
APP.INIT.loadAssets = function() {
    // Start loading progress
    let totalAssets = 1; // Start with 1 for the 3D model
    let loadedAssets = 0;
    
    // Add a timeout to prevent getting stuck on loading
    const loadingTimeout = setTimeout(() => {
        console.log("Loading timeout reached - forcing completion");
        // Force loading to complete if it takes too long
        if (loadedAssets < totalAssets) {
            // Create fallback model
            APP.MODEL.createFallbackModel();
            
            // Hide loading overlay
            APP.ELEMENTS.loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                APP.ELEMENTS.loadingOverlay.style.display = 'none';
                APP.STATE.isAppInitialized = true;
            }, APP.CONFIG.FADE_DURATION || 800);
        }
    }, 10000); // 10 second timeout
    
    // Update loading progress
    const updateProgress = () => {
        loadedAssets++;
        const progress = (loadedAssets / totalAssets) * 100;
        if (APP.ELEMENTS.loadingBar) {
            APP.ELEMENTS.loadingBar.style.width = `${progress}%`;
        }
        
        if (loadedAssets >= totalAssets) {
            // All assets loaded, clear timeout
            clearTimeout(loadingTimeout);
            
            // Initialize app
            setTimeout(() => {
                APP.ELEMENTS.loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    APP.ELEMENTS.loadingOverlay.style.display = 'none';
                    APP.STATE.isAppInitialized = true;
                }, APP.CONFIG.FADE_DURATION || 800);
            }, 500);
        }
    };
    
    // For this demo, we'll simulate loading audio
    APP.INIT.setupAudio();
    
    // Simulate loading audio assets - will increment loadedAssets
    setTimeout(updateProgress, 3000);
    
    // Load 3D model (actual loading is in APP.MODEL.loadModel)
    APP.MODEL.loadModel();
};

// Fix 2: Replace the Three.js model loading function with this more robust version
APP.MODEL.loadModel = function() {
    try {
        // Display loading notification
        if (APP.UI && APP.UI.showNotification) {
            APP.UI.showNotification('Loading Model', 'Loading your 3D model...');
        }
        
        const modelUrl = APP.CONFIG.MODEL_URL;
        
        // Create fallback model immediately to use if loading fails
        APP.MODEL.createFallbackModel();
        
        // If no URL is specified, just use the fallback model
        if (!modelUrl) {
            console.log("No model URL specified, using fallback model");
            return;
        }
        
        try {
            // Determine the file extension
            const fileExtension = modelUrl.split('.').pop().toLowerCase();
            
            if (fileExtension === 'glb' || fileExtension === 'gltf') {
                // Load GLTF model if loader exists
                if (typeof THREE.GLTFLoader === 'function') {
                    const loader = new THREE.GLTFLoader();
                    
                    // Use DRACOLoader if available
                    if (typeof THREE.DRACOLoader === 'function') {
                        const dracoLoader = new THREE.DRACOLoader();
                        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.4.1/');
                        loader.setDRACOLoader(dracoLoader);
                    }
                    
                    loader.load(
                        modelUrl,
                        (gltf) => {
                            APP.MODEL.onModelLoaded(gltf.scene);
                            
                            // Handle animations if present
                            if (gltf.animations && gltf.animations.length > 0) {
                                const mixer = new THREE.AnimationMixer(gltf.scene);
                                APP.THREE.animationMixers.push(mixer);
                                
                                gltf.animations.forEach((clip) => {
                                    mixer.clipAction(clip).play();
                                });
                            }
                        },
                        (xhr) => {
                            // Loading progress
                            if (xhr.total > 0) {
                                const percentComplete = (xhr.loaded / xhr.total) * 100;
                                if (APP.ELEMENTS.loadingBar) {
                                    APP.ELEMENTS.loadingBar.style.width = `${percentComplete}%`;
                                }
                            }
                        },
                        (error) => {
                            console.error('Error loading model:', error);
                            if (APP.UI && APP.UI.showNotification) {
                                APP.UI.showNotification('Error', 'Failed to load 3D model. Using fallback model.', 'error');
                            }
                        }
                    );
                } else {
                    console.error('GLTFLoader not available');
                    // We already created a fallback model above
                }
            } else {
                console.log('Using fallback model - custom model loaders not implemented');
                // We already created a fallback model above
            }
        } catch (e) {
            console.error('Error in model loading process:', e);
            // We already created a fallback model above
        }
    } catch (e) {
        console.error('Critical error in model loading:', e);
        // Force loading to complete
        if (APP.ELEMENTS.loadingOverlay) {
            APP.ELEMENTS.loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                APP.ELEMENTS.loadingOverlay.style.display = 'none';
            }, 800);
        }
    }
};

// Fix 3: Add this safer initialization code at the end of the file
window.addEventListener('load', function() {
    try {
        // Initialize only if not already initialized
        if (typeof APP !== 'undefined' && !APP.STATE.isAppInitialized) {
            APP.INIT.initialize();
        } else if (typeof APP === 'undefined') {
            console.error('APP object not defined properly');
            
            // Emergency fix: Hide loading screen if APP is undefined
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 800);
            }
        }
    } catch (e) {
        console.error('Error during initialization:', e);
        
        // Emergency fix: Hide loading screen if there's an error
        const loadingOverlay = document.querySelector('.loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 800);
        }
    }
});

// Fix 4: Add this fallback error handling for the Three.js setup
try {
    if (typeof APP !== 'undefined' && APP.MODEL && !APP.MODEL.initializeScene) {
        // Add a fallback scene initializer
        APP.MODEL.initializeScene = function() {
            try {
                // Create scene
                APP.THREE.scene = new THREE.Scene();
                APP.THREE.scene.background = new THREE.Color(0x0a1015);
                
                // Create camera
                APP.THREE.camera = new THREE.PerspectiveCamera(
                    45,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                
                // Set initial camera position
                APP.THREE.camera.position.set(0, 0, 5);
                
                // Create renderer
                APP.THREE.renderer = new THREE.WebGLRenderer({
                    canvas: APP.ELEMENTS.modelCanvas,
                    antialias: true,
                    alpha: true
                });
                
                APP.THREE.renderer.setSize(
                    window.innerWidth,
                    window.innerHeight
                );
                
                // Add basic light
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(1, 1, 1);
                APP.THREE.scene.add(light);
                
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
                APP.THREE.scene.add(ambientLight);
                
                // Start animation loop
                const animate = function() {
                    requestAnimationFrame(animate);
                    if (APP.THREE.renderer && APP.THREE.scene && APP.THREE.camera) {
                        APP.THREE.renderer.render(APP.THREE.scene, APP.THREE.camera);
                    }
                };
                
                animate();
                
            } catch (e) {
                console.error('Error in fallback scene initialization:', e);
            }
        };
    }
} catch (e) {
    console.error('Error setting up fallback scene initializer:', e);
}
        
        // Load assets
        APP.INIT.loadAssets = function() {
            // Start loading progress
            let totalAssets = 1; // Start with 1 for the 3D model
            let loadedAssets = 0;
            
            // Update loading progress
            const updateProgress = () => {
                loadedAssets++;
                const progress = (loadedAssets / totalAssets) * 100;
                APP.ELEMENTS.loadingBar.style.width = `${progress}%`;
                
                if (loadedAssets >= totalAssets) {
                    // All assets loaded, initialize app
                    setTimeout(() => {
                        APP.ELEMENTS.loadingOverlay.style.opacity = '0';
                        setTimeout(() => {
                            APP.ELEMENTS.loadingOverlay.style.display = 'none';
                            APP.STATE.isAppInitialized = true;
                        }, APP.CONFIG.FADE_DURATION);
                    }, 500);
                }
            };
            
            // Load audio assets (in a real app, you would load actual audio files)
            // For this demo, we'll simulate loading audio
            APP.INIT.setupAudio();
            
            // Here we would normally loop through all the prayer and mystery audio files
            // and load them, incrementing totalAssets and calling updateProgress when each loads
            // For the demo, we'll simulate loading 5 seconds later
            setTimeout(updateProgress, 3000);
            
            // Load 3D model (actual loading is in APP.MODEL.loadModel)
            APP.MODEL.loadModel();
        };

        // Set up audio
        APP.INIT.setupAudio = function() {
            // Create audio objects
            APP.AUDIO.backgroundMusic = new Howl({
                src: ['background_music.mp3'], // This would be a real path in a production app
                loop: true,
                volume: APP.STATE.musicVolume,
                autoplay: false,
                preload: true
            });
            
            APP.AUDIO.prayerAudio = new Howl({
                src: [''], // Will be set dynamically
                volume: APP.STATE.voiceVolume,
                autoplay: false,
                preload: true,
                onend: function() {
                    if (APP.STATE.isAutoAdvanceEnabled && APP.STATE.isPlaying) {
                        setTimeout(() => {
                            APP.CORE.nextPrayer();
                        }, APP.CONFIG.AUTO_ADVANCE_DELAY);
                    }
                }
            });
            
            // Add sound effects
            APP.AUDIO.effects.click = new Howl({
                src: ['click.mp3'],
                volume: 0.5,
                preload: true
            });
            
            APP.AUDIO.effects.transition = new Howl({
                src: ['transition.mp3'],
                volume: 0.3,
                preload: true
            });
            
            APP.AUDIO.effects.complete = new Howl({
                src: ['complete.mp3'],
                volume: 0.5,
                preload: true
            });
        };

        // Create the rosary sequence
        APP.CORE.createRosarySequence = function(mysteryType) {
            const sequence = [];
            
            // Start with the Sign of the Cross and Apostles' Creed
            sequence.push({prayer: 'signOfCross', type: 'prayer', bead: null});
            sequence.push({prayer: 'apostlesCreed', type: 'prayer', bead: null});
            
            // First Our Father
            sequence.push({prayer: 'ourFather', type: 'prayer', bead: 'opening-our-father'});
            
            // First three Hail Marys
            for (let i = 0; i < 3; i++) {
                sequence.push({prayer: 'hailMary', type: 'prayer', bead: `opening-hail-mary-${i+1}`});
            }
            
            // Glory Be
            sequence.push({prayer: 'gloryBe', type: 'prayer', bead: null});
            
            // Five decades
            for (let decade = 0; decade < 5; decade++) {
                // Announce mystery
                sequence.push({
                    type: 'mystery',
                    mysteryIndex: decade,
                    mysteryType: mysteryType,
                    bead: null
                });
                
                // Our Father
                sequence.push({prayer: 'ourFather', type: 'prayer', decade: decade, bead: `decade-${decade+1}-our-father`});
                
                // 10 Hail Marys
                for (let bead = 0; bead < 10; bead++) {
                    sequence.push({prayer: 'hailMary', type: 'prayer', decade: decade, bead: `decade-${decade+1}-hail-mary-${bead+1}`});
                }
                
                // Glory Be and Fatima Prayer
                sequence.push({prayer: 'gloryBe', type: 'prayer', decade: decade, bead: null});
                sequence.push({prayer: 'fatimaPrayer', type: 'prayer', decade: decade, bead: null});
            }
            
            // Conclude with Hail Holy Queen and final prayer
            sequence.push({prayer: 'hailHolyQueen', type: 'prayer', bead: null});
            sequence.push({prayer: 'finalPrayer', type: 'prayer', bead: null});
            sequence.push({prayer: 'signOfCross', type: 'prayer', bead: null});
            
            APP.DATA.rosarySequence = sequence;
            return sequence;
        };

        // Set liturgical colors based on current date
        APP.CORE.setLiturgicalColors = function() {
            const now = new Date();
            const month = now.getMonth() + 1; // getMonth() returns 0-11
            const day = now.getDate();
            const dateKey = `${month}-${day}`;
            
            // Default to Ordinary Time
            let season = APP.DATA.liturgicalCalendar[dateKey] || 0;
            
            // Map season to name
            const seasonNames = [
                'ordinary', // 0 - Ordinary Time
                'advent',   // 1 - Advent
                'christmas',// 2 - Christmas
                'lent',     // 3 - Lent
                'easter',   // 4 - Easter
                'feast'     // 5 - Feast days
            ];
            
            APP.STATE.liturgicalSeason = seasonNames[season];
            APP.CORE.setThemeColors(APP.STATE.liturgicalSeason);
        };

        // Set theme colors based on liturgical season
        APP.CORE.setThemeColors = function(season) {
            const root = document.documentElement;
            
            switch (season) {
                case 'ordinary': // Ordinary Time - Green
                    root.style.setProperty('--primary-color', '#35724a');
                    root.style.setProperty('--secondary-color', '#264d33');
                    root.style.setProperty('--accent-color', '#e6c875');
                    break;
                case 'advent': // Advent - Purple
                    root.style.setProperty('--primary-color', '#5d3b6c');
                    root.style.setProperty('--secondary-color', '#3f2a49');
                    root.style.setProperty('--accent-color', '#c9a7db');
                    break;
                case 'christmas': // Christmas - White/Gold
                    root.style.setProperty('--primary-color', '#b39247');
                    root.style.setProperty('--secondary-color', '#7a6331');
                    root.style.setProperty('--accent-color', '#f5e7c1');
                    break;
                case 'lent': // Lent - Purple
                    root.style.setProperty('--primary-color', '#6c3b5d');
                    root.style.setProperty('--secondary-color', '#49293f');
                    root.style.setProperty('--accent-color', '#dba7c9');
                    break;
                case 'easter': // Easter - White/Gold
                    root.style.setProperty('--primary-color', '#b3a247');
                    root.style.setProperty('--secondary-color', '#8c7e38');
                    root.style.setProperty('--accent-color', '#f5f1c1');
                    break;
                case 'feast': // Feast Days - Red
                    root.style.setProperty('--primary-color', '#8c2e2e');
                    root.style.setProperty('--secondary-color', '#6b2424');
                    root.style.setProperty('--accent-color', '#f0b7b7');
                    break;
            }
            
            // If dark mode is disabled, adjust background colors
            if (!APP.STATE.darkModeEnabled) {
                root.style.setProperty('--background-color', '#f8f5f0');
                root.style.setProperty('--overlay-color', 'rgba(248, 245, 240, 0.85)');
                root.style.setProperty('--text-color', '#2c2418');
            } else {
                root.style.setProperty('--background-color', '#0a1015');
                root.style.setProperty('--overlay-color', 'rgba(10, 16, 21, 0.85)');
                root.style.setProperty('--text-color', '#f8f1e2');
            }
        };

        // Start the rosary prayer
        APP.CORE.startRosary = function() {
            // Update rosary sequence with selected mystery type
            APP.CORE.createRosarySequence(APP.STATE.currentMysteryType);
            
            // Reset prayer index
            APP.STATE.currentPrayerIndex = 0;
            
            // Hide landing page
            APP.ELEMENTS.landingPage.style.opacity = '0';
            APP.ELEMENTS.landingPage.style.transform = 'translateY(-20px)';
            
            // Play transition sound
            APP.AUDIO.effects.transition.play();
            
            // Start background music if enabled
            if (APP.ELEMENTS.backgroundMusicToggle.checked) {
                APP.AUDIO.backgroundMusic.play();
            }
            
            setTimeout(() => {
                APP.ELEMENTS.landingPage.style.display = 'none';
                
                // Display first prayer
                APP.UI.updatePrayerDisplay();
                
                // Setup beads display
                APP.UI.setupBeadIndicator();
            }, APP.CONFIG.FADE_DURATION);
        };

        // Navigate to the next prayer
        APP.CORE.nextPrayer = function() {
            if (APP.STATE.currentPrayerIndex < APP.DATA.rosarySequence.length - 1) {
                // Play click sound
                APP.AUDIO.effects.click.play();
                
                // Stop current audio if playing
                if (APP.STATE.isPlaying) {
                    APP.AUDIO.prayerAudio.stop();
                }
                
                APP.STATE.currentPrayerIndex++;
                APP.UI.updatePrayerDisplay();
                
                // Start audio for new prayer if auto-playing
                if (APP.STATE.isPlaying && APP.STATE.voiceGuidanceEnabled) {
                    APP.CORE.playPrayerAudio();
                }
            } else {
                // End of rosary reached
                APP.AUDIO.effects.complete.play();
                APP.UI.showNotification('Rosary Complete', 'You have completed praying the rosary. God bless you!');
            }
        };

        // Navigate to the previous prayer
        APP.CORE.prevPrayer = function() {
            if (APP.STATE.currentPrayerIndex > 0) {
                // Play click sound
                APP.AUDIO.effects.click.play();
                
                // Stop current audio if playing
                if (APP.STATE.isPlaying) {
                    APP.AUDIO.prayerAudio.stop();
                }
                
                APP.STATE.currentPrayerIndex--;
                APP.UI.updatePrayerDisplay();
                
                // Start audio for new prayer if auto-playing
                if (APP.STATE.isPlaying && APP.STATE.voiceGuidanceEnabled) {
                    APP.CORE.playPrayerAudio();
                }
            }
        };

        // Toggle play/pause
        APP.CORE.togglePlay = function() {
            APP.STATE.isPlaying = !APP.STATE.isPlaying;
            
            if (APP.STATE.isPlaying) {
                APP.ELEMENTS.playBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                if (APP.STATE.voiceGuidanceEnabled) {
                    APP.CORE.playPrayerAudio();
                }
            } else {
                APP.ELEMENTS.playBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                APP.AUDIO.prayerAudio.pause();
            }
        };

        // Play current prayer audio
        APP.CORE.playPrayerAudio = function() {
            const currentItem = APP.DATA.rosarySequence[APP.STATE.currentPrayerIndex];
            let audioFile = '';
            
            if (currentItem.type === 'prayer') {
                audioFile = APP.DATA.prayers[currentItem.prayer].audio;
            } else if (currentItem.type === 'mystery') {
                const mystery = APP.DATA.mysteries[currentItem.mysteryType][currentItem.mysteryIndex];
                audioFile = mystery.audio;
            }
            
            // In a real app, you would actually load and play the audio file
            // For demo purposes, we'll simulate playing
            console.log(`Playing audio: ${audioFile}`);
            
            // Simulate prayer audio duration and auto-advance
            if (APP.STATE.isPlaying) {
                const duration = APP.CORE.getAudioDuration(currentItem);
                
                setTimeout(() => {
                    if (APP.STATE.isPlaying && APP.STATE.isAutoAdvanceEnabled && 
                        APP.STATE.currentPrayerIndex < APP.DATA.rosarySequence.length - 1) {
                        APP.CORE.nextPrayer();
                    } else if (APP.STATE.isPlaying && 
                               APP.STATE.currentPrayerIndex === APP.DATA.rosarySequence.length - 1) {
                        // End of rosary reached
                        APP.STATE.isPlaying = false;
                        APP.ELEMENTS.playBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                        APP.AUDIO.effects.complete.play();
                        APP.UI.showNotification('Rosary Complete', 'You have completed praying the rosary. God bless you!');
                    }
                }, duration);
            }
        };

        // Get audio duration for a prayer or mystery
        APP.CORE.getAudioDuration = function(item) {
            if (item.type === 'prayer') {
                return APP.DATA.prayers[item.prayer].duration;
            } else if (item.type === 'mystery') {
                // Mysteries have a longer meditation time
                const baseDuration = 15000; // 15 seconds
                
                // Add additional time based on meditation duration setting
                const meditationTimes = {
                    'none': 0,
                    'short': 5000,
                    'medium': 10000,
                    'long': 15000
                };
                
                return baseDuration + meditationTimes[APP.STATE.meditationDuration];
            }
            
            return 5000; // Default duration
        };

        // Set volume for all audio
        APP.CORE.setVolume = function(volume) {
            APP.AUDIO.backgroundMusic.volume(volume * APP.STATE.musicVolume);
            APP.AUDIO.prayerAudio.volume(volume * APP.STATE.voiceVolume);
            Object.values(APP.AUDIO.effects).forEach(effect => {
                effect.volume(volume * 0.5);
            });
        };

        // Initialize the 3D scene
        APP.MODEL.initializeScene = function() {
            // Create scene
            APP.THREE.scene = new THREE.Scene();
            APP.THREE.scene.background = new THREE.Color(APP.CONFIG.DEFAULT_BACKGROUND_COLOR);
            
            // Create camera
            APP.THREE.camera = new THREE.PerspectiveCamera(
                APP.CONFIG.CAMERA_FOV,
                APP.ELEMENTS.modelCanvas.clientWidth / APP.ELEMENTS.modelCanvas.clientHeight,
                0.1,
                1000
            );
            
            // Set initial camera position
            APP.THREE.camera.position.set(
                APP.CONFIG.DEFAULT_CAMERA_POSITION.x,
                APP.CONFIG.DEFAULT_CAMERA_POSITION.y,
                APP.CONFIG.DEFAULT_CAMERA_POSITION.z
            );
            
            // Create renderer
            APP.THREE.renderer = new THREE.WebGLRenderer({
                canvas: APP.ELEMENTS.modelCanvas,
                antialias: true,
                alpha: true
            });
            
            APP.THREE.renderer.setSize(
                APP.ELEMENTS.modelCanvas.clientWidth,
                APP.ELEMENTS.modelCanvas.clientHeight
            );
            
            APP.THREE.renderer.setPixelRatio(window.devicePixelRatio);
            APP.THREE.renderer.shadowMap.enabled = true;
            APP.THREE.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            APP.THREE.renderer.outputEncoding = THREE.sRGBEncoding;
            
            // Add lights
            APP.MODEL.setupLights();
            
            // Add orbit controls
            APP.THREE.controls = new THREE.OrbitControls(APP.THREE.camera, APP.THREE.renderer.domElement);
            APP.THREE.controls.enableDamping = true;
            APP.THREE.controls.dampingFactor = 0.05;
            APP.THREE.controls.screenSpacePanning = false;
            APP.THREE.controls.minDistance = 2;
            APP.THREE.controls.maxDistance = 10;
            APP.THREE.controls.maxPolarAngle = Math.PI / 1.5;
            
            // Initialize raycaster for model interaction
            APP.THREE.raycaster = new THREE.Raycaster();
            APP.THREE.mouse = new THREE.Vector2();
            
            // Create animation clock
            APP.THREE.clock = new THREE.Clock();
            
            // Start the render loop
            APP.MODEL.animate();
        };

        // Set up the lights
        APP.MODEL.setupLights = function() {
            // Main directional light
            const mainLight = new THREE.DirectionalLight(0xffffff, APP.CONFIG.LIGHT_INTENSITY);
            mainLight.position.set(5, 5, 5);
            mainLight.castShadow = true;
            
            // Optimize shadow map
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            mainLight.shadow.camera.near = 0.5;
            mainLight.shadow.camera.far = 50;
            mainLight.shadow.bias = -0.0001;
            
            const d = 10;
            mainLight.shadow.camera.left = -d;
            mainLight.shadow.camera.right = d;
            mainLight.shadow.camera.top = d;
            mainLight.shadow.camera.bottom = -d;
            
            APP.THREE.scene.add(mainLight);
            APP.THREE.lights.main = mainLight;
            
            // Secondary directional light (fill light)
            const fillLight = new THREE.DirectionalLight(0xffffff, APP.CONFIG.LIGHT_INTENSITY * 0.5);
            fillLight.position.set(-5, 3, -5);
            APP.THREE.scene.add(fillLight);
            APP.THREE.lights.fill = fillLight;
            
            // Bottom light for subtle illumination
            const bottomLight = new THREE.DirectionalLight(0xffffff, APP.CONFIG.LIGHT_INTENSITY * 0.2);
            bottomLight.position.set(0, -5, 0);
            APP.THREE.scene.add(bottomLight);
            APP.THREE.lights.bottom = bottomLight;
            
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, APP.CONFIG.AMBIENT_LIGHT_INTENSITY);
            APP.THREE.scene.add(ambientLight);
            APP.THREE.lights.ambient = ambientLight;
            
            // Add candle-like point lights
            const candleLight1 = new THREE.PointLight(0xffcc88, 1, 10, 2);
            candleLight1.position.set(2, 1, 2);
            APP.THREE.scene.add(candleLight1);
            APP.THREE.lights.candle1 = candleLight1;
            
            const candleLight2 = new THREE.PointLight(0xffcc88, 1, 10, 2);
            candleLight2.position.set(-2, 1, -2);
            APP.THREE.scene.add(candleLight2);
            APP.THREE.lights.candle2 = candleLight2;
            
            // Animate candle lights
            APP.MODEL.animateCandleLights();
        };

        // Animate candle lights for flickering effect
        APP.MODEL.animateCandleLights = function() {
            const updateLight = (light) => {
                // Random intensity fluctuation
                const baseIntensity = 1;
                const fluctuation = 0.2;
                const newIntensity = baseIntensity + (Math.random() * fluctuation - fluctuation / 2);
                light.intensity = newIntensity;
                
                // Subtle position fluctuation
                const positionFluctuation = 0.05;
                light.position.x += (Math.random() * positionFluctuation - positionFluctuation / 2);
                light.position.y += (Math.random() * positionFluctuation - positionFluctuation / 2);
                light.position.z += (Math.random() * positionFluctuation - positionFluctuation / 2);
            };
            
            // Update every 100ms for subtle flickering
            setInterval(() => {
                if (APP.CONFIG.ANIMATION_ENABLED) {
                    updateLight(APP.THREE.lights.candle1);
                    updateLight(APP.THREE.lights.candle2);
                }
            }, 100);
        };

        // Cycle through lighting schemes
        APP.MODEL.cycleLighting = function() {
            // Define lighting schemes
            const schemes = [
                { name: 'Standard', main: 1.5, fill: 0.75, bottom: 0.3, ambient: 0.4, candle: 1.0 },
                { name: 'Dramatic', main: 2.0, fill: 0.3, bottom: 0.1, ambient: 0.2, candle: 1.5 },
                { name: 'Soft', main: 1.0, fill: 1.0, bottom: 0.5, ambient: 0.6, candle: 0.7 },
                { name: 'Candlelit', main: 0.5, fill: 0.3, bottom: 0.1, ambient: 0.3, candle: 2.0 },
                { name: 'Bright', main: 2.0, fill: 1.5, bottom: 1.0, ambient: 0.8, candle: 0.5 }
            ];
            
            // Get the current scheme or use default
            let currentSchemeIndex = APP.STATE.currentLightingSchemeIndex || 0;
            
            // Move to next scheme
            currentSchemeIndex = (currentSchemeIndex + 1) % schemes.length;
            APP.STATE.currentLightingSchemeIndex = currentSchemeIndex;
            
            const scheme = schemes[currentSchemeIndex];
            
            // Apply the scheme
            APP.THREE.lights.main.intensity = scheme.main;
            APP.THREE.lights.fill.intensity = scheme.fill;
            APP.THREE.lights.bottom.intensity = scheme.bottom;
            APP.THREE.lights.ambient.intensity = scheme.ambient;
            APP.THREE.lights.candle1.intensity = scheme.candle;
            APP.THREE.lights.candle2.intensity = scheme.candle;
            
            // Display notification
            APP.UI.showNotification('Lighting Changed', `Switched to ${scheme.name} lighting`);
        };

        // Animation loop
        APP.MODEL.animate = function() {
            requestAnimationFrame(APP.MODEL.animate);
            
            // Update controls
            APP.THREE.controls.update();
            
            // Update any animations
            const delta = APP.THREE.clock.getDelta();
            APP.THREE.animationMixers.forEach(mixer => mixer.update(delta));
            
            // Auto-rotate model if enabled
            if (APP.STATE.autoRotationEnabled && APP.THREE.model) {
                APP.THREE.model.rotation.y += APP.CONFIG.MODEL_ROTATION_SPEED;
            }
            
            // Render scene
            APP.THREE.renderer.render(APP.THREE.scene, APP.THREE.camera);
        };

        // Load 3D model
        APP.MODEL.loadModel = function() {
            // Use appropriate loader based on the model file extension
            // For this example, we'll use GLTFLoader assuming you have a .glb or .gltf model
            
            // Display loading notification
            APP.UI.showNotification('Loading Model', 'Loading your 3D model...');
            
            const modelUrl = APP.CONFIG.MODEL_URL;
            
            // Determine the file extension
            const fileExtension = modelUrl.split('.').pop().toLowerCase();
            
            // Create a DRACOLoader for compressed models (optional, but improves loading performance)
            const dracoLoader = new THREE.DRACOLoader();
            dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.4.1/');
            
            if (fileExtension === 'glb' || fileExtension === 'gltf') {
                // Load GLTF model
                const loader = new THREE.GLTFLoader();
                loader.setDRACOLoader(dracoLoader);
                
                loader.load(
                    modelUrl,
                    (gltf) => {
                        APP.MODEL.onModelLoaded(gltf.scene);
                        
                        // Handle animations if present
                        if (gltf.animations && gltf.animations.length > 0) {
                            const mixer = new THREE.AnimationMixer(gltf.scene);
                            APP.THREE.animationMixers.push(mixer);
                            
                            gltf.animations.forEach((clip) => {
                                mixer.clipAction(clip).play();
                            });
                        }
                    },
                    (xhr) => {
                        // Loading progress
                        const percentComplete = (xhr.loaded / xhr.total) * 100;
                        APP.ELEMENTS.loadingBar.style.width = `${percentComplete}%`;
                    },
                    (error) => {
                        console.error('Error loading model:', error);
                        APP.UI.showNotification('Error', 'Failed to load 3D model. Using fallback model.', 'error');
                        
                        // Load a fallback model or create a simple geometry
                        APP.MODEL.createFallbackModel();
                    }
                );
            } else if (fileExtension === 'obj') {
                // Load OBJ model
                const mtlLoader = new THREE.MTLLoader();
                
                // Assume there's a corresponding .mtl file with the same base name
                const mtlUrl = modelUrl.replace('.obj', '.mtl');
                
                mtlLoader.load(
                    mtlUrl,
                    (materials) => {
                        materials.preload();
                        
                        const objLoader = new THREE.OBJLoader();
                        objLoader.setMaterials(materials);
                        
                        objLoader.load(
                            modelUrl,
                            (obj) => {
                                APP.MODEL.onModelLoaded(obj);
                            },
                            (xhr) => {
                                // Loading progress
                                const percentComplete = (xhr.loaded / xhr.total) * 100;
                                APP.ELEMENTS.loadingBar.style.width = `${percentComplete}%`;
                            },
                            (error) => {
                                console.error('Error loading model:', error);
                                APP.UI.showNotification('Error', 'Failed to load 3D model. Using fallback model.', 'error');
                                
                                // Load a fallback model or create a simple geometry
                                APP.MODEL.createFallbackModel();
                            }
                        );
                    },
                    undefined,
                    (error) => {
                        console.error('Error loading materials:', error);
                        
                        // Try loading the OBJ without materials
                        const objLoader = new THREE.OBJLoader();
                        
                        objLoader.load(
                            modelUrl,
                            (obj) => {
                                APP.MODEL.onModelLoaded(obj);
                            },
                            undefined,
                            (error) => {
                                console.error('Error loading model:', error);
                                APP.MODEL.createFallbackModel();
                            }
                        );
                    }
                );
            } else if (fileExtension === 'fbx') {
                // Load FBX model
                const loader = new THREE.FBXLoader();
                
                loader.load(
                    modelUrl,
                    (fbx) => {
                        APP.MODEL.onModelLoaded(fbx);
                        
                        // Handle animations if present
                        if (fbx.animations && fbx.animations.length > 0) {
                            const mixer = new THREE.AnimationMixer(fbx);
                            APP.THREE.animationMixers.push(mixer);
                            
                            fbx.animations.forEach((clip) => {
                                mixer.clipAction(clip).play();
                            });
                        }
                    },
                    (xhr) => {
                        // Loading progress
                        const percentComplete = (xhr.loaded / xhr.total) * 100;
                        APP.ELEMENTS.loadingBar.style.width = `${percentComplete}%`;
                    },
                    (error) => {
                        console.error('Error loading model:', error);
                        APP.UI.showNotification('Error', 'Failed to load 3D model. Using fallback model.', 'error');
                        
                        // Load a fallback model or create a simple geometry
                        APP.MODEL.createFallbackModel();
                    }
                );
            } else {
                // Unsupported file format
                console.error('Unsupported file format:', fileExtension);
                APP.UI.showNotification('Error', 'Unsupported 3D model format. Using fallback model.', 'error');
                
                // Create a fallback model
                APP.MODEL.createFallbackModel();
            }
        };

        // Handle model once loaded
        APP.MODEL.onModelLoaded = function(model) {
            // Clear any existing model
            if (APP.THREE.model) {
                APP.THREE.scene.remove(APP.THREE.model);
            }
            
            // Add the new model to the scene
            APP.THREE.model = model;
            APP.THREE.scene.add(model);
            
            // Apply scale
            model.scale.set(
                APP.CONFIG.MODEL_SCALE,
                APP.CONFIG.MODEL_SCALE,
                APP.CONFIG.MODEL_SCALE
            );
            
            // Center the model
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.x = -center.x;
            model.position.y = -center.y;
            model.position.z = -center.z;
            
            // Adjust camera to fit model
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = APP.THREE.camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
            cameraZ *= 1.5; // Adjust as needed
            
            APP.THREE.camera.position.z = cameraZ;
            const minZ = box.min.z;
            const cameraToFarEdge = (minZ < 0) ? -minZ + cameraZ : cameraZ - minZ;
            APP.THREE.camera.far = cameraToFarEdge * 3;
            APP.THREE.camera.updateProjectionMatrix();
            
            // Reset controls target to the center of the model
            APP.THREE.controls.target.set(0, 0, 0);
            APP.THREE.controls.update();
            
            // Enable shadows on the model
            model.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    
                    // Improve material quality based on selected model quality
                    APP.MODEL.setMaterialQuality(node, APP.STATE.modelQuality);
                }
            });
            
            // Model loaded successfully
            APP.STATE.isModelLoaded = true;
            APP.UI.showNotification('Model Loaded', 'Your 3D model has been loaded successfully.');
            
            // Initial positioning based on first prayer
            APP.MODEL.positionForCurrentPrayer();
        };

        // Set material quality based on settings
        APP.MODEL.setMaterialQuality = function(node, quality) {
            if (node.material) {
                // Clone the material to avoid affecting other meshes
                if (Array.isArray(node.material)) {
                    node.material = node.material.map(m => m.clone());
                } else {
                    node.material = node.material.clone();
                }
                
                const materials = Array.isArray(node.material) ? node.material : [node.material];
                
                materials.forEach(material => {
                    switch (quality) {
                        case 'low':
                            material.roughness = 0.7;
                            material.metalness = 0.3;
                            material.envMapIntensity = 0.5;
                            break;
                        case 'medium':
                            material.roughness = 0.5;
                            material.metalness = 0.5;
                            material.envMapIntensity = 1.0;
                            break;
                        case 'high':
                            material.roughness = 0.3;
                            material.metalness = 0.7;
                            material.envMapIntensity = 1.5;
                            break;
                    }
                });
            }
        };

        // Set model quality
        APP.MODEL.setModelQuality = function(quality) {
            if (APP.THREE.model) {
                APP.THREE.model.traverse((node) => {
                    if (node.isMesh) {
                        APP.MODEL.setMaterialQuality(node, quality);
                    }
                });
            }
        };

        // Create a fallback model if the main model fails to load
        APP.MODEL.createFallbackModel = function() {
            // Create a simple rosary model as a fallback
            const group = new THREE.Group();
            
            // Create cross
            const crossMaterial = new THREE.MeshStandardMaterial({
                color: 0xe6c875,
                metalness: 0.8,
                roughness: 0.2
            });
            
            const verticalBar = new THREE.Mesh(
                new THREE.BoxGeometry(0.1, 0.6, 0.05),
                crossMaterial
            );
            verticalBar.position.y = -0.2;
            group.add(verticalBar);
            
            const horizontalBar = new THREE.Mesh(
                new THREE.BoxGeometry(0.3, 0.1, 0.05),
                crossMaterial
            );
            horizontalBar.position.y = -0.05;
            group.add(horizontalBar);
            
            // Create beads
            const beadGeometry = new THREE.SphereGeometry(0.05, 16, 16);
            const mainBeadMaterial = new THREE.MeshStandardMaterial({
                color: 0xe6c875,
                metalness: 0.5,
                roughness: 0.3
            });
            
            const smallBeadMaterial = new THREE.MeshStandardMaterial({
                color: 0xf8f1e2,
                metalness: 0.3,
                roughness: 0.4
            });
            
            // Create a circle of beads
            const radius = 0.8;
            const totalBeads = 50;
            
            for (let i = 0; i < totalBeads; i++) {
                const isLargeBead = i % 10 === 0;
                const angle = (i / totalBeads) * Math.PI * 2;
                
                const bead = new THREE.Mesh(
                    beadGeometry,
                    isLargeBead ? mainBeadMaterial : smallBeadMaterial
                );
                
                bead.position.x = Math.sin(angle) * radius;
                bead.position.z = Math.cos(angle) * radius;
                
                // Make large beads slightly larger
                if (isLargeBead) {
                    bead.scale.set(1.3, 1.3, 1.3);
                }
                
                // Set bead ID for highlight interaction
                bead.name = `bead-${i}`;
                
                group.add(bead);
            }
            
            // Add connecting chain (simple line segments)
            const chainMaterial = new THREE.LineBasicMaterial({ color: 0xe6c875 });
            
            // Connect beads to form a chain
            for (let i = 0; i < totalBeads; i++) {
                const startAngle = (i / totalBeads) * Math.PI * 2;
                const endAngle = ((i + 1) % totalBeads / totalBeads) * Math.PI * 2;
                
                const startX = Math.sin(startAngle) * radius;
                const startZ = Math.cos(startAngle) * radius;
                
                const endX = Math.sin(endAngle) * radius;
                const endZ = Math.cos(endAngle) * radius;
                
                const chainGeometry = new THREE.BufferGeometry().setFromPoints([
                    new THREE.Vector3(startX, 0, startZ),
                    new THREE.Vector3(endX, 0, endZ)
                ]);
                
                const chain = new THREE.Line(chainGeometry, chainMaterial);
                group.add(chain);
            }
            
            // Connect last bead to the cross
            const lastBeadAngle = (0 / totalBeads) * Math.PI * 2;
            const lastBeadX = Math.sin(lastBeadAngle) * radius;
            const lastBeadZ = Math.cos(lastBeadAngle) * radius;
            
            const connectingGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(lastBeadX, 0, lastBeadZ),
                new THREE.Vector3(0, -0.2, 0)
            ]);
            
            const connectingChain = new THREE.Line(connectingGeometry, chainMaterial);
            group.add(connectingChain);
            
            // Handle model as if it was loaded
            APP.MODEL.onModelLoaded(group);
        };

        // Position the model for the current prayer
        APP.MODEL.positionForCurrentPrayer = function() {
            if (!APP.THREE.model || !APP.DATA.rosarySequence) return;
            
            const currentItem = APP.DATA.rosarySequence[APP.STATE.currentPrayerIndex];
            
            // If this prayer has an associated bead, highlight it
            if (currentItem.bead && APP.STATE.highlightBeadEnabled) {
                APP.MODEL.highlightBead(currentItem.bead);
            } else {
                APP.MODEL.clearHighlights();
            }
            
            // Position and rotate model based on the current prayer
            let position = { x: 0, y: 0, z: 0 };
            let rotation = { x: 0, y: 0, z: 0 };
            
            // If this is a mystery, use its defined position and rotation
            if (currentItem.type === 'mystery') {
                const mystery = APP.DATA.mysteries[currentItem.mysteryType][currentItem.mysteryIndex];
                position = mystery.modelPosition || position;
                rotation = mystery.modelRotation || rotation;
            }
            
            // Animate the model to new position using GSAP
            if (APP.CONFIG.ANIMATION_ENABLED) {
                gsap.to(APP.THREE.model.position, {
                    x: position.x,
                    y: position.y,
                    z: position.z,
                    duration: 1.5,
                    ease: "power2.inOut"
                });
                
                gsap.to(APP.THREE.model.rotation, {
                    x: rotation.x,
                    y: rotation.y,
                    z: rotation.z,
                    duration: 1.5,
                    ease: "power2.inOut"
                });
            } else {
                // Apply immediately
                APP.THREE.model.position.set(position.x, position.y, position.z);
                APP.THREE.model.rotation.set(rotation.x, rotation.y, rotation.z);
            }
        };

        // Highlight specific bead in the model
        APP.MODEL.highlightBead = function(beadId) {
            if (!APP.THREE.model) return;
            
            // Clear previous highlights
            APP.MODEL.clearHighlights();
            
            // Find the bead with the matching ID/name
            APP.THREE.model.traverse((node) => {
                if (node.isMesh && (node.name === beadId || node.name === `bead-${beadId}`)) {
                    // Store original material
                    node.userData.originalMaterial = node.material;
                    
                    // Create a highlighted material
                    const highlightedMaterial = node.material.clone();
                    highlightedMaterial.emissive = new THREE.Color(0xe6c875);
                    highlightedMaterial.emissiveIntensity = 0.5;
                    
                    // Add glow effect
                    if (APP.CONFIG.ANIMATION_ENABLED) {
                        gsap.to(highlightedMaterial, {
                            emissiveIntensity: 1.0,
                            duration: 1.0,
                            repeat: -1,
                            yoyo: true,
                            ease: "sine.inOut"
                        });
                    }
                    
                    node.material = highlightedMaterial;
                    
                    // Scale up the bead slightly
                    node.userData.originalScale = {
                        x: node.scale.x,
                        y: node.scale.y,
                        z: node.scale.z
                    };
                    
                    if (APP.CONFIG.ANIMATION_ENABLED) {
                        gsap.to(node.scale, {
                            x: node.scale.x * 1.2,
                            y: node.scale.y * 1.2,
                            z: node.scale.z * 1.2,
                            duration: 0.5,
                            ease: "back.out"
                        });
                    } else {
                        node.scale.set(
                            node.scale.x * 1.2,
                            node.scale.y * 1.2,
                            node.scale.z * 1.2
                        );
                    }
                }
            });
        };

        // Clear all highlights from the model
        APP.MODEL.clearHighlights = function() {
            if (!APP.THREE.model) return;
            
            APP.THREE.model.traverse((node) => {
                if (node.isMesh && node.userData.originalMaterial) {
                    // Restore original material
                    node.material = node.userData.originalMaterial;
                    node.userData.originalMaterial = null;
                    
                    // Restore original scale
                    if (node.userData.originalScale) {
                        if (APP.CONFIG.ANIMATION_ENABLED) {
                            gsap.to(node.scale, {
                                x: node.userData.originalScale.x,
                                y: node.userData.originalScale.y,
                                z: node.userData.originalScale.z,
                                duration: 0.5,
                                ease: "back.out"
                            });
                        } else {
                            node.scale.set(
                                node.userData.originalScale.x,
                                node.userData.originalScale.y,
                                node.userData.originalScale.z
                            );
                        }
                        
                        node.userData.originalScale = null;
                    }
                }
            });
        };

        // Zoom in the camera
        APP.MODEL.zoomIn = function() {
            gsap.to(APP.THREE.camera.position, {
                z: APP.THREE.camera.position.z * 0.8,
                duration: 0.5,
                ease: "power2.out",
                onUpdate: function() {
                    APP.THREE.camera.updateProjectionMatrix();
                }
            });
        };

        // Zoom out the camera
        APP.MODEL.zoomOut = function() {
            gsap.to(APP.THREE.camera.position, {
                z: APP.THREE.camera.position.z * 1.25,
                duration: 0.5,
                ease: "power2.out",
                onUpdate: function() {
                    APP.THREE.camera.updateProjectionMatrix();
                }
            });
        };

        // Reset camera view
        APP.MODEL.resetView = function() {
            gsap.to(APP.THREE.camera.position, {
                x: APP.CONFIG.DEFAULT_CAMERA_POSITION.x,
                y: APP.CONFIG.DEFAULT_CAMERA_POSITION.y,
                z: APP.CONFIG.DEFAULT_CAMERA_POSITION.z,
                duration: 1.0,
                ease: "power2.inOut",
                onUpdate: function() {
                    APP.THREE.camera.updateProjectionMatrix();
                }
            });
            
            gsap.to(APP.THREE.controls.target, {
                x: 0,
                y: 0,
                z: 0,
                duration: 1.0,
                ease: "power2.inOut",
                onUpdate: function() {
                    APP.THREE.controls.update();
                }
            });
        };

        // Toggle auto-rotation
        APP.MODEL.toggleAutoRotation = function() {
            APP.STATE.autoRotationEnabled = !APP.STATE.autoRotationEnabled;
            APP.ELEMENTS.rotateBtn.classList.toggle('active', APP.STATE.autoRotationEnabled);
            APP.ELEMENTS.autoRotationToggle.checked = APP.STATE.autoRotationEnabled;
            
            APP.UI.showNotification('Auto Rotation', 
                APP.STATE.autoRotationEnabled ? 'Auto rotation enabled' : 'Auto rotation disabled');
        };

        // Set auto-rotation
        APP.MODEL.setAutoRotation = function(enabled) {
            APP.STATE.autoRotationEnabled = enabled;
            APP.ELEMENTS.rotateBtn.classList.toggle('active', enabled);
        };

        // Initialize particle system
        APP.PARTICLE_SYSTEM.initialize = function() {
            // Create canvas for particles
            const canvas = document.createElement('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '1';
            
            APP.ELEMENTS.particlesContainer.appendChild(canvas);
            
            APP.PARTICLES.canvas = canvas;
            APP.PARTICLES.ctx = canvas.getContext('2d');
            
            // Create particles
            APP.PARTICLE_SYSTEM.createParticles();
            
            // Start animation
            APP.PARTICLE_SYSTEM.animate();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        };

        // Create particles
        APP.PARTICLE_SYSTEM.createParticles = function() {
            APP.PARTICLES.particles = [];
            
            // Create dust particles
            for (let i = 0; i < APP.CONFIG.PARTICLE_COUNT; i++) {
                APP.PARTICLES.particles.push({
                    x: Math.random() * APP.PARTICLES.canvas.width,
                    y: Math.random() * APP.PARTICLES.canvas.height,
                    size: Math.random() * 3 + 1,
                    speedX: Math.random() * 0.5 - 0.25,
                    speedY: Math.random() * 0.5 - 0.25,
                    opacity: Math.random() * 0.5 + 0.1,
                    color: `rgba(255, 220, 150, ${Math.random() * 0.3 + 0.1})`
                });
            }
        };

        // Animate particles
        APP.PARTICLE_SYSTEM.animate = function() {
            if (!APP.CONFIG.ANIMATION_ENABLED) {
                // Skip particle rendering if animations are disabled
                requestAnimationFrame(APP.PARTICLE_SYSTEM.animate);
                return;
            }
            
            APP.PARTICLES.ctx.clearRect(0, 0, APP.PARTICLES.canvas.width, APP.PARTICLES.canvas.height);
            
            APP.PARTICLES.particles.forEach(particle => {
                // Move particle
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                
                // Wrap around screen edges
                if (particle.x < 0) particle.x = APP.PARTICLES.canvas.width;
                if (particle.x > APP.PARTICLES.canvas.width) particle.x = 0;
                if (particle.y < 0) particle.y = APP.PARTICLES.canvas.height;
                if (particle.y > APP.PARTICLES.canvas.height) particle.y = 0;
                
                // Gently vary opacity for shimmer effect
                particle.opacity += Math.random() * 0.02 - 0.01;
                if (particle.opacity < 0.1) particle.opacity = 0.1;
                if (particle.opacity > 0.4) particle.opacity = 0.4;
                
                // Draw particle
                APP.PARTICLES.ctx.beginPath();
                APP.PARTICLES.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                APP.PARTICLES.ctx.fillStyle = `rgba(255, 220, 150, ${particle.opacity})`;
                APP.PARTICLES.ctx.fill();
            });
            
            requestAnimationFrame(APP.PARTICLE_SYSTEM.animate);
        };

        // Apply settings
        APP.SETTINGS.applySettings = function() {
            // Apply text size
            APP.ELEMENTS.prayerText.style.fontSize = `${APP.CONFIG.PRAYER_TEXT_BASE_SIZE * APP.STATE.textSizeMultiplier}px`;
            
            // Apply animations setting
            document.body.classList.toggle('animations-disabled', !APP.CONFIG.ANIMATION_ENABLED);
            
            // Apply auto rotation
            APP.MODEL.setAutoRotation(APP.STATE.autoRotationEnabled);
            
            // Apply dark mode
            if (APP.STATE.darkModeEnabled) {
                document.documentElement.classList.remove('light-mode');
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
                document.documentElement.classList.add('light-mode');
            }
            
            // Re-apply liturgical colors with dark mode consideration
            APP.CORE.setLiturgicalColors();
            
            // Apply volume settings
            if (APP.AUDIO.backgroundMusic) {
                APP.AUDIO.backgroundMusic.volume(APP.STATE.musicVolume);
            }
            
            if (APP.AUDIO.prayerAudio) {
                APP.AUDIO.prayerAudio.volume(APP.STATE.voiceVolume);
            }
        };

        // Toggle settings modal
        APP.SETTINGS.toggleSettingsModal = function() {
            APP.STATE.isModalOpen = !APP.STATE.isModalOpen;
            APP.ELEMENTS.settingsModal.classList.toggle('visible', APP.STATE.isModalOpen);
        };

        // Setup bead indicator
        APP.UI.setupBeadIndicator = function() {
            // Clear existing beads
            APP.ELEMENTS.beadIndicator.innerHTML = '';
            
            // Create 10 beads for a decade
            for (let i = 0; i < 10; i++) {
                const bead = document.createElement('div');
                bead.className = 'bead';
                APP.ELEMENTS.beadIndicator.appendChild(bead);
            }
        };

        // Update prayer display
        APP.UI.updatePrayerDisplay = function() {
            // Get current prayer item
            const currentItem = APP.DATA.rosarySequence[APP.STATE.currentPrayerIndex];
            
            // Fade out current content
            APP.ELEMENTS.prayerScroll.style.opacity = '0';
            
            setTimeout(() => {
                // Update content based on prayer type
                if (currentItem.type === 'prayer') {
                    const prayer = APP.DATA.prayers[currentItem.prayer];
                    APP.ELEMENTS.prayerTitle.textContent = prayer.title;
                    APP.ELEMENTS.prayerInstructions.textContent = prayer.instructions;
                    APP.ELEMENTS.prayerText.innerHTML = `<p>${prayer.text}</p>`;
                } else if (currentItem.type === 'mystery') {
                    const mystery = APP.DATA.mysteries[currentItem.mysteryType][currentItem.mysteryIndex];
                    APP.ELEMENTS.prayerTitle.textContent = mystery.title;
                    APP.ELEMENTS.prayerInstructions.textContent = 'Meditate on this mystery';
                    
                    // Add description and scripture if enabled
                    let content = `<p>${mystery.description}</p>`;
                    
                    if (APP.STATE.showScriptureEnabled) {
                        content += `<p class="scripture">${mystery.scripture}</p>`;
                    }
                    
                    content += `<p class="fruits">${mystery.fruits}</p>`;
                    APP.ELEMENTS.prayerText.innerHTML = content;
                    
                    // Update mystery info panel
                    APP.ELEMENTS.mysteryInfo.querySelector('.mystery-title').textContent = mystery.title;
                    APP.ELEMENTS.mysteryInfo.querySelector('.mystery-description').textContent = mystery.description;
                    APP.ELEMENTS.mysteryInfo.querySelector('.mystery-fruits').textContent = mystery.fruits;
                    APP.ELEMENTS.mysteryInfo.classList.add('visible');
                    
                    // Hide mystery info after a delay
                    setTimeout(() => {
                        APP.ELEMENTS.mysteryInfo.classList.remove('visible');
                    }, 5000);
                }
                
                // Update progress indicators
                APP.UI.updateProgressIndicators();
                
                // Update 3D model position and highlights
                APP.MODEL.positionForCurrentPrayer();
                
                // Fade in new content
                APP.ELEMENTS.prayerScroll.style.opacity = '1';
            }, 300);
        };

        // Update progress indicators (beads and decade dots)
        APP.UI.updateProgressIndicators = function() {
            const currentItem = APP.DATA.rosarySequence[APP.STATE.currentPrayerIndex];
            
            // Determine current decade and bead
            let currentDecade = 0;
            let currentBead = 0;
            
            if (currentItem.decade !== undefined) {
                currentDecade = currentItem.decade + 1; // +1 because we start with decade 0 for intro prayers
            }
            
            // Update decade dots
            APP.ELEMENTS.decadeDots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                
                if (index < currentDecade) {
                    dot.classList.add('completed');
                } else if (index === currentDecade) {
                    dot.classList.add('active');
                }
            });
            
            // Update progress title
            if (currentDecade === 0) {
                APP.ELEMENTS.progressTitle.textContent = 'Opening Prayers';
            } else if (currentDecade > 5) {
                APP.ELEMENTS.progressTitle.textContent = 'Closing Prayers';
            } else {
                const ordinals = ['First', 'Second', 'Third', 'Fourth', 'Fifth'];
                APP.ELEMENTS.progressTitle.textContent = `${ordinals[currentDecade - 1]} Decade`;
            }
            
            // Update bead indicators
            const beads = document.querySelectorAll('.bead');
            
            // Hide beads for non-decade prayers
            if (currentItem.type === 'mystery' || 
                (currentItem.type === 'prayer' && 
                 !['ourFather', 'hailMary'].includes(currentItem.prayer))) {
                beads.forEach(bead => {
                    bead.style.display = 'none';
                });
                return;
            }
            
            // Show beads for decade prayers
            beads.forEach((bead, index) => {
                bead.style.display = 'block';
                bead.classList.remove('active', 'completed', 'larger');
                
                // Our Father is a larger bead
                if (currentItem.prayer === 'ourFather') {
                    bead.classList.add('larger');
                    if (index === 0) {
                        bead.classList.add('active');
                    }
                } 
                // For Hail Mary, highlight the current bead
                else if (currentItem.prayer === 'hailMary') {
                    // Find which Hail Mary we're on in the current decade
                    const hailMaryIndex = APP.DATA.rosarySequence
                        .slice(0, APP.STATE.currentPrayerIndex + 1)
                        .filter(item => 
                            item.prayer === 'hailMary' && 
                            item.decade === currentItem.decade
                        ).length - 1;
                    
                    if (index < hailMaryIndex) {
                        bead.classList.add('completed');
                    } else if (index === hailMaryIndex) {
                        bead.classList.add('active');
                    }
                }
            });
        };

        // Show notification
        APP.UI.showNotification = function(title, message, type = 'info') {
            // Set notification content
            APP.ELEMENTS.notificationTitle.textContent = title;
            APP.ELEMENTS.notificationMessage.textContent = message;
            
            // Apply notification type
            APP.ELEMENTS.notification.className = 'notification';
            APP.ELEMENTS.notification.classList.add(`notification-${type}`);
            
            // Show notification
            APP.ELEMENTS.notification.classList.add('visible');
            
            // Hide after delay
            setTimeout(() => {
                APP.UI.hideNotification();
            }, 4000);
        };

        // Hide notification
        APP.UI.hideNotification = function() {
            APP.ELEMENTS.notification.classList.remove('visible');
        };

        // Set language
        APP.LANGUAGE.setLanguage = function(languageCode) {
            // In a real app, we would load translations for the selected language
            // For demo purposes, we'll just show a notification
            APP.UI.showNotification('Language Changed', `Language set to ${APP.LANGUAGE.getLanguageName(languageCode)}`);
        };

        // Get language name from code
        APP.LANGUAGE.getLanguageName = function(code) {
            const languages = {
                'en': 'English',
                'la': 'Latin',
                'es': 'Spanish',
                'fr': 'French',
                'it': 'Italian',
                'pl': 'Polish',
                'pt': 'Portuguese'
            };
            
            return languages[code] || 'Unknown';
        };

        // Helper function to get ordinal suffix
        APP.UTILS.getOrdinal = function(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        };

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            APP.INIT.initialize();
        });
    </script>
</body>
</html>
